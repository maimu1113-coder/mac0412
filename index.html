<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MacTok Pro Premium</title>
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <style>
        body { font-family: sans-serif; background: #000; color: #fff; margin: 0; padding: 10px; }
        .header { display: flex; justify-content: space-between; padding: 5px; border-bottom: 1px solid #333; }
        .timer { color: #00f2ea; font-family: monospace; font-size: 1.2rem; }
        .controls { display: flex; gap: 5px; margin: 10px 0; }
        input { flex: 1; padding: 10px; border-radius: 5px; background: #111; color: #fff; border: 1px solid #444; }
        button { padding: 10px; border-radius: 5px; border: none; background: #ff0050; color: #fff; font-weight: bold; }
        #log { height: 60vh; overflow-y: auto; border: 1px solid #222; margin-top: 10px; display: flex; flex-direction: column-reverse; }
        .comment { padding: 5px; border-bottom: 1px solid #111; font-size: 0.9rem; }
        .user { color: #00f2ea; font-weight: bold; }
        .gift-msg { background: linear-gradient(45deg, #ff0050, #9000ff); padding: 8px; border-radius: 5px; margin: 5px; border: 1px solid #fff; }
        /* å°çª“ç”¨ãƒ“ãƒ‡ã‚ªï¼ˆéš ã—ï¼‰ */
        #pipVideo { width: 1px; height: 1px; opacity: 0; }
    </style>
</head>
<body>
    <div class="header">
        <div id="status">ğŸ”´ æœªæ¥ç¶š</div>
        <div class="timer" id="timer">00:00:00</div>
    </div>

    <div class="controls">
        <input type="text" id="targetId" placeholder="TikTok ID">
        <button onclick="connect()">é–‹å§‹</button>
        <button onclick="initVoice()" style="background: #00f2ea; color: #000;">ğŸ”Š éŸ³å£°ON</button>
        <button onclick="togglePiP()" id="pipBtn" style="background: #444;">ğŸ“º å°çª“</button>
    </div>

    <div id="log"></div>

    <canvas id="pipCanvas" width="400" height="500" style="display:none;"></canvas>
    <video id="pipVideo" autoplay muted playsinline></video>

    <script>
        const WS_URL = "https://mactok-engine.onrender.com";
        let socket, startTime, timerInterval;
        let isVoiceEnabled = false;
        let messages = [];

        const canvas = document.getElementById('pipCanvas');
        const ctx = canvas.getContext('2d');
        const video = document.getElementById('pipVideo');

        function initVoice() {
            const u = new SpeechSynthesisUtterance("èª­ã¿ä¸Šã’ã‚’é–‹å§‹ã—ã¾ã™");
            u.lang = 'ja-JP';
            window.speechSynthesis.speak(u);
            isVoiceEnabled = true;
            alert("éŸ³å£°ã¨å°çª“ã®æº–å‚™ãŒå®Œäº†ã—ã¾ã—ãŸã€‚æ¥ç¶šå¾Œã«ã€Œå°çª“ã€ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚");
        }

        function speak(text) {
            if (!isVoiceEnabled) return;
            const u = new SpeechSynthesisUtterance(text);
            u.lang = 'ja-JP';
            u.rate = 1.2;
            window.speechSynthesis.speak(u);
        }

        function updateTimer() {
            const diff = Math.floor((new Date() - startTime) / 1000);
            const h = String(Math.floor(diff / 3600)).padStart(2, '0');
            const m = String(Math.floor((diff % 3600) / 60)).padStart(2, '0');
            const s = String(diff % 60).padStart(2, '0');
            document.getElementById('timer').innerText = `${h}:${m}:${s}`;
        }

        function connect() {
            const id = document.getElementById('targetId').value.trim();
            if(!id) return;
            socket = io(WS_URL);
            socket.on('connect', () => {
                socket.emit('start', id);
                document.getElementById('status').innerText = "ğŸŸ¢ æ¥ç¶šä¸­";
                startTime = new Date();
                timerInterval = setInterval(() => { updateTimer(); drawCanvas(); }, 1000);
            });

            socket.on('chat', data => {
                const msg = `${data.user}: ${data.text}`;
                addLog(`<div class="comment"><span class="user">${data.user}</span>: ${data.text}</div>`, msg);
                speak(msg);
            });

            socket.on('gift', data => {
                const msg = `ğŸ ${data.user}ãŒ${data.gift}ã‚’è´ˆã‚Šã¾ã—ãŸï¼`;
                addLog(`<div class="gift-msg">${msg}</div>`, msg);
                speak(msg);
            });
        }

        function addLog(html, text) {
            document.getElementById('log').insertAdjacentHTML('afterbegin', html);
            messages.unshift(text);
            if(messages.length > 15) messages.pop();
        }

        // ã‚­ãƒ£ãƒ³ãƒã‚¹ï¼ˆå°çª“ã®ä¸­èº«ï¼‰ã‚’æç”»
        function drawCanvas() {
            ctx.fillStyle = "#000";
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            ctx.fillStyle = "#00f2ea";
            ctx.font = "bold 24px Arial";
            ctx.fillText("TikTok Live Monitor", 10, 40);
            ctx.fillStyle = "#fff";
            ctx.font = "18px Arial";
            messages.forEach((m, i) => {
                ctx.fillText(m, 10, 80 + (i * 30));
            });
        }

        // å°çª“ãƒœã‚¿ãƒ³ã®å‹•ä½œ
        async function togglePiP() {
            try {
                if (document.pictureInPictureElement) {
                    await document.exitPictureInPicture();
                } else {
                    const stream = canvas.captureStream(10); // ã‚­ãƒ£ãƒ³ãƒã‚¹ã‚’æ˜ åƒåŒ–
                    video.srcObject = stream;
                    await video.play();
                    await video.requestPictureInPicture();
                }
            } catch (err) {
                console.error(err);
                alert("å°çª“ã®èµ·å‹•ã«å¤±æ•—ã—ã¾ã—ãŸã€‚å…ˆã«ã€ŒéŸ³å£°ONã€ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ã‹ã‚‰è©¦ã—ã¦ãã ã•ã„ã€‚");
            }
        }
    </script>
</body>
</html>
