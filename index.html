<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>TikTok診断モード</title>
    <script src="https://cdn.jsdelivr.net/npm/tiktok-live-connect@0.1.1/dist/browser/tiktok-live-connect.min.js"></script>
    <style>
        body { background:#111; color:#fff; text-align:center; font-family:sans-serif; padding:20px; }
        input { padding:15px; width:80%; margin-bottom:10px; border-radius:10px; }
        button { padding:15px; width:80%; background:#ff0050; color:#fff; border-radius:10px; font-weight:bold; }
        #status { margin:20px; color:#ffdd00; }
        #log { background:#000; height:200px; overflow-y:auto; border:1px solid #444; padding:10px; text-align:left; font-size:12px; }
    </style>
</head>
<body>
    <h2>TikTok 読み上げテスト</h2>
    <input type="text" id="idInput" placeholder="TikTok ID (@抜き)">
    <br><br>
    <button id="sBtn">テスト開始</button>
    <div id="status">状態: 停止中</div>
    <div id="log">ここにログが出ます</div>

    <script>
        const btn = document.getElementById('sBtn');
        const status = document.getElementById('status');
        const log = document.getElementById('log');

        function addLog(m) {
            const d = document.createElement('div');
            d.innerText = m;
            log.prepend(d);
        }

        btn.onclick = () => {
            const id = document.getElementById('idInput').value.trim();
            if(!id) { alert("IDを入力してください"); return; }

            status.innerText = "状態: 接続を試みています...";
            addLog("ID: " + id + " に接続開始...");

            try {
                // 音声テスト
                const uttr = new SpeechSynthesisUtterance("テスト開始");
                window.speechSynthesis.speak(uttr);

                const con = new TikTokLiveConnector.WebcastPushConnection(id);

                con.connect().then(state => {
                    status.innerText = "状態: ✅ 接続成功！";
                    addLog("成功！ライブを監視しています...");
                }).catch(err => {
                    status.innerText = "状態: ❌ エラー";
                    addLog("エラー詳細: " + err);
                });

                con.on('chat', data => {
                    addLog(data.nickname + ": " + data.comment);
                    const msg = new SpeechSynthesisUtterance(data.nickname + "さん " + data.comment);
                    window.speechSynthesis.speak(msg);
                });
            } catch (e) {
                addLog("プログラム実行エラー: " + e);
            }
        };
    </script>
</body>
</html>
