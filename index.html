<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Mac Talk PRO Final</title>
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
</head>
<body style="background:#000; color:#fff; text-align:center; padding-top:50px; font-family:sans-serif;">
    <h1 style="color:#00f2ea;">Mac Talk PRO</h1>
    <input type="text" id="targetId" placeholder="TikTok ID" value="macrecords1" style="padding:15px; width:80%; font-size:16px; border-radius:10px; margin-bottom:20px;">
    <br>
    
    <div id="clickArea" style="margin:20px auto; width:180px; height:180px; background:#ff0050; border-radius:50%; display:flex; align-items:center; justify-content:center; cursor:pointer; box-shadow: 0 0 20px #ff0050;">
        <span style="font-size:24px; font-weight:bold; color:#fff;">START</span>
    </div>

    <video id="v" playsinline muted autoplay style="width:180px; height:120px; margin:10px auto; background:#222; border:2px solid #00f2ea; border-radius:10px;"></video>
    <canvas id="c" width="100" height="100" style="display:none;"></canvas>

    <script>
        const v = document.getElementById('v');
        const c = document.getElementById('c');
        const clickArea = document.getElementById('clickArea');
        let socket;

        // 音声再生を「強制的に」起こす関数
        function speak(text) {
            window.speechSynthesis.cancel();
            const uttr = new SpeechSynthesisUtterance(text);
            uttr.lang = 'ja-JP';
            uttr.rate = 1.0;
            uttr.pitch = 1.0;
            window.speechSynthesis.speak(uttr);
        }

        clickArea.addEventListener('click', async () => {
            const id = document.getElementById('targetId').value.trim();
            
            // 1. まず無音の音声を流して、iPhoneのスピーカーを「ON」にする
            speak("システムを起動します。接続をお待ちください。");

            // 2. 小窓（ビデオ）の起動
            v.srcObject = c.captureStream();
            await v.play();
            if (v.webkitSetPresentationMode) {
                v.webkitSetPresentationMode("picture-in-picture");
            }

            // 3. サーバーへ接続
            if(socket) socket.close();
            socket = io("https://mactok-engine.onrender.com", { transports: ['websocket'] });

            socket.on('connect', () => {
                setTimeout(() => speak("サーバーに接続しました。コメントを読み上げます。"), 1000);
            });

            socket.on('chat', data => {
                // コメントを読み上げ
                speak(data.user + "さん、" + data.text);
            });

            socket.emit('start', id);
        });
    </script>
</body>
</html>
