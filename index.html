<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MacTok Pro Premium</title>
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <style>
        body { font-family: 'Helvetica Neue', sans-serif; background: #050505; color: #fff; margin: 0; padding: 20px; overflow: hidden; }
        .container { max-width: 500px; margin: 0 auto; }
        h2 { text-align: center; color: #00f2ea; text-shadow: 0 0 10px #00f2ea; font-size: 1.2rem; }
        
        /* å…¥åŠ›ã‚¨ãƒªã‚¢ */
        .controls { display: flex; gap: 10px; margin-bottom: 20px; }
        input { flex: 1; padding: 12px; border-radius: 8px; border: 1px solid #333; background: #111; color: #fff; }
        button { padding: 12px 20px; border-radius: 8px; border: none; background: #ff0050; color: #fff; font-weight: bold; cursor: pointer; }
        
        /* ãƒ­ã‚°ã‚¨ãƒªã‚¢ */
        #log { height: 70vh; overflow-y: auto; background: rgba(20, 20, 20, 0.8); border-radius: 15px; padding: 15px; border: 1px solid #222; }
        .comment { margin-bottom: 12px; animation: fadeIn 0.3s ease; line-height: 1.4; }
        .user { color: #00f2ea; font-weight: bold; font-size: 0.9rem; margin-right: 5px; }
        .gift-msg { background: linear-gradient(90deg, #ff0050, #ff00d0); padding: 8px; border-radius: 8px; font-weight: bold; color: #fff; border: 1px solid #fff; }
        
        /* å°çª“ï¼ˆPiPï¼‰ç”¨ã‚­ãƒ£ãƒ³ãƒã‚¹ï¼ˆéè¡¨ç¤ºï¼‰ */
        canvas { display: none; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>
    <div class="container">
        <h2>MacTok Pro Premium ğŸš€</h2>
        <div class="controls">
            <input type="text" id="targetId" placeholder="TikTok ID (@ãªã—)">
            <button onclick="connect()">æ¥ç¶š</button>
            <button onclick="startPiP()" id="pipBtn" style="background: #444;">å°çª“</button>
        </div>
        <div id="log"></div>
    </div>

    <video id="pipVideo" autoplay muted playsinline style="display:none;"></video>
    <canvas id="pipCanvas" width="400" height="600"></canvas>

    <script>
        const WS_URL = "wss://mactok-engine.onrender.com"; 
        let socket;
        const logDiv = document.getElementById('log');
        const canvas = document.getElementById('pipCanvas');
        const ctx = canvas.getContext('2d');
        const video = document.getElementById('pipVideo');

        function connect() {
            const id = document.getElementById('targetId').value.trim();
            if(!id) return;
            socket = io(WS_URL);
            socket.on('connect', () => socket.emit('start', id));
            
            socket.on('chat', data => addLog(`<span class="user">${data.user}</span> ${data.text}`));
            socket.on('gift', data => addLog(`<div class="gift-msg">ğŸ ${data.user}ãŒ${data.gift}ã‚’Ã—${data.count}å€‹è´ˆã‚Šã¾ã—ãŸï¼</div>`));
        }

        function addLog(html) {
            const div = document.createElement('div');
            div.className = "comment";
            div.innerHTML = html;
            logDiv.prepend(div);
            updateCanvas(); // å°çª“ã®ä¸­èº«ã‚’æ›´æ–°
        }

        // å°çª“è¡¨ç¤ºï¼ˆPicture-in-Pictureï¼‰ã®ä»•çµ„ã¿
        async function startPiP() {
            try {
                const stream = canvas.captureStream();
                video.srcObject = stream;
                await video.play();
                await video.requestPictureInPicture();
            } catch (err) {
                alert("ã“ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯å°çª“è¡¨ç¤ºã«å¯¾å¿œã—ã¦ã„ã¾ã›ã‚“");
            }
        }

        // ã‚­ãƒ£ãƒ³ãƒã‚¹ã«æ–‡å­—ã‚’æç”»ï¼ˆå°çª“ã«æ˜ ã‚‹å†…å®¹ï¼‰
        function updateCanvas() {
            ctx.fillStyle = "#000";
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            ctx.fillStyle = "#fff";
            ctx.font = "20px Arial";
            const messages = Array.from(logDiv.innerText.split('\n')).slice(0, 20);
            messages.forEach((m, i) => ctx.fillText(m, 10, 30 + (i * 30)));
        }
        setInterval(updateCanvas, 500); // åŠç§’ã”ã¨ã«å°çª“ã‚’æ›´æ–°
    </script>
</body>
</html>
