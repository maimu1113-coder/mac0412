<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MacTok Pro Final</title>
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <style>
        body { font-family: sans-serif; background: #000; color: #fff; margin: 0; padding: 10px; }
        .timer { color: #00f2ea; font-family: monospace; font-size: 1.2rem; text-align: right; margin-bottom: 5px; }
        .controls { display: flex; gap: 5px; margin-bottom: 10px; }
        input { flex: 1; padding: 12px; border-radius: 8px; background: #111; color: #fff; border: 1px solid #444; font-size: 16px; }
        button { padding: 12px; border-radius: 8px; border: none; background: #ff0050; color: #fff; font-weight: bold; }
        #pipVideo { width: 100%; height: 180px; background: #111; border: 1px solid #00f2ea; border-radius: 8px; margin-bottom: 10px; }
        #log { height: 40vh; overflow-y: auto; border-top: 1px solid #333; padding-top: 10px; display: flex; flex-direction: column-reverse; }
        .comment { padding: 5px; font-size: 0.9rem; border-bottom: 1px solid #222; }
        .user { color: #00f2ea; font-weight: bold; }
    </style>
</head>
<body>
    <div class="timer" id="timer">00:00:00</div>
    
    <div class="controls">
        <input type="text" id="targetId" placeholder="TikTok ID (@ãªã—)">
        <button onclick="startApp()">é–‹å§‹</button>
        <button onclick="togglePiP()" style="background:#444">å°çª“</button>
    </div>

    <video id="pipVideo" autoplay muted playsinline></video>
    <canvas id="pipCanvas" width="400" height="400" style="display:none;"></canvas>

    <div id="log"></div>

    <script>
        // â˜…é‡è¦â˜… ã“ã“ã‚’è‡ªåˆ†ã®Renderã®URLï¼ˆhttps://...ï¼‰ã«æ›¸ãæ›ãˆã¦ãã ã•ã„
        const WS_URL = "https://mactok-engine.onrender.com"; 

        let socket, startTime, timerInterval;
        let messages = [];
        const canvas = document.getElementById('pipCanvas');
        const ctx = canvas.getContext('2d');
        const video = document.getElementById('pipVideo');

        // ã‚¢ãƒ—ãƒªèµ·å‹•
        async function startApp() {
            // éŸ³å£°ã¨ãƒ“ãƒ‡ã‚ªã®æº–å‚™
            const u = new SpeechSynthesisUtterance("ã‚·ã‚¹ãƒ†ãƒ ã‚ªãƒ³ãƒ©ã‚¤ãƒ³");
            window.speechSynthesis.speak(u);
            
            const stream = canvas.captureStream(10);
            video.srcObject = stream;
            await video.play();

            const id = document.getElementById('targetId').value.trim();
            if(!id) return alert("IDã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");

            if(socket) socket.disconnect();
            connect(id);
        }

        function connect(id) {
            socket = io(WS_URL, { transports: ['websocket'] });

            socket.on('connect', () => {
                startTime = new Date();
                socket.emit('start', id);
                if(timerInterval) clearInterval(timerInterval);
                timerInterval = setInterval(() => { updateTimer(); drawCanvas(); }, 1000);
                addLog("SYSTEM", "ã‚µãƒ¼ãƒãƒ¼ã«æ¥ç¶šã—ã¾ã—ãŸ");
            });

            socket.on('chat', data => {
                addLog(data.user, data.text);
                speak(`${data.user}ã€${data.text}`);
            });

            socket.on('gift', data => {
                const msg = `ğŸ ${data.gift}ã‚’è´ˆã‚Šã¾ã—ãŸï¼`;
                addLog(data.user, msg);
                speak(`${data.user}ã•ã‚“ã€${data.gift}ã‚ã‚ŠãŒã¨ã†ï¼`);
            });

            socket.on('connect_error', () => {
                addLog("ERROR", "æ¥ç¶šã«å¤±æ•—ã—ã¾ã—ãŸã€‚RenderãŒèµ·å‹•ä¸­ã‹ç¢ºèªã—ã¦ãã ã•ã„ã€‚");
            });
        }

        function addLog(user, text) {
            const div = document.createElement('div');
            div.className = "comment";
            div.innerHTML = `<span class="user">${user}</span>: ${text}`;
            document.getElementById('log').prepend(div);
            messages.unshift(`${user}: ${text}`);
            if(messages.length > 10) messages.pop();
        }

        function speak(text) {
            const u = new SpeechSynthesisUtterance(text);
            u.lang = 'ja-JP';
            u.rate = 1.2;
            window.speechSynthesis.speak(u);
        }

        function drawCanvas() {
            ctx.fillStyle = "#000";
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            ctx.fillStyle = "#00f2ea";
            ctx.font = "bold 24px Arial";
            ctx.fillText("MacTok Monitor", 10, 40);
            ctx.fillStyle = "#fff";
            ctx.font = "18px Arial";
            messages.forEach((m, i) => ctx.fillText(m, 10, 80 + (i * 30)));
        }

        function updateTimer() {
            const diff = Math.floor((new Date() - startTime) / 1000);
            document.getElementById('timer').innerText = new Date(diff * 1000).toISOString().substr(11, 8);
        }

        async function togglePiP() {
            try {
                if (document.pictureInPictureElement) {
                    await document.exitPictureInPicture();
                } else {
                    await video.requestPictureInPicture();
                }
            } catch (err) {
                alert("å…ˆã«ã€é–‹å§‹ã€ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦æ˜ åƒã‚’å‹•ã‹ã—ã¦ãã ã•ã„");
            }
        }
    </script>
</body>
</html>
