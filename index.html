<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Mac Talk PRO</title>
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
</head>
<body style="background:#000; color:#fff; text-align:center; padding-top:50px; font-family:sans-serif;">
    <h1 style="color:#00f2ea;">Mac Talk PRO</h1>
    <input type="text" id="targetId" placeholder="TikTok ID" style="padding:15px; width:80%; font-size:16px; border-radius:10px; margin-bottom:20px;">
    <br>
    
    <div id="clickArea" style="margin:20px auto; width:250px; height:250px; background:#ff0050; border-radius:50%; display:flex; align-items:center; justify-content:center; cursor:pointer; box-shadow: 0 0 20px #ff0050;">
        <span style="font-size:24px; font-weight:bold; color:#fff;">START</span>
    </div>

    <video id="v" playsinline muted style="width:100px; height:100px; margin-top:20px; border:1px solid #333;"></video>
    <canvas id="c" width="100" height="100" style="display:none;"></canvas>

    <script>
        const v = document.getElementById('v');
        const c = document.getElementById('c');
        const clickArea = document.getElementById('clickArea');

        function speak(text) {
            const uttr = new SpeechSynthesisUtterance(text);
            uttr.lang = 'ja-JP';
            window.speechSynthesis.cancel();
            window.speechSynthesis.speak(uttr);
        }

        clickArea.addEventListener('click', async () => {
            const id = document.getElementById('targetId').value.trim();
            if(!id) return alert("TikTok IDを入力してください");

            // 音声テスト
            speak("起動します。");

            // 小窓（動画）の準備
            v.srcObject = c.captureStream();
            await v.play();
            
            // iPhoneに小窓を強制する命令
            if (v.webkitSetPresentationMode) {
                v.webkitSetPresentationMode("picture-in-picture");
            }

            // サーバー接続
            const socket = io("https://mactok-engine.onrender.com", { transports: ['websocket'] });
            socket.on('connect', () => {
                setTimeout(() => speak("接続しました"), 1000);
            });
            socket.on('chat', data => {
                speak(data.user + "さん、" + data.text);
            });
            socket.emit('start', id);
        });
    </script>
</body>
</html>
