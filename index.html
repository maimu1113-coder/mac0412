<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Mac Talk PRO Final</title>
  <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
</head>

<body style="background:#000; color:#fff; text-align:center; padding-top:50px; font-family:sans-serif;">
  <h1 style="color:#00f2ea;">Mac Talk PRO</h1>

  <input
    type="text"
    id="targetId"
    placeholder="TikTok ID"
    value="macrecords1"
    style="padding:15px; width:80%; font-size:16px; border-radius:10px; margin-bottom:20px;"
  >

  <div
    id="clickArea"
    style="margin:20px auto; width:180px; height:180px; background:#ff0050;
    border-radius:50%; display:flex; align-items:center; justify-content:center;
    cursor:pointer; box-shadow:0 0 20px #ff0050;"
  >
    <span style="font-size:24px; font-weight:bold;">START</span>
  </div>

  <video id="v" playsinline muted autoplay
    style="width:180px; height:120px; margin:10px auto; background:#222;
    border:2px solid #00f2ea; border-radius:10px;">
  </video>

  <canvas id="c" width="100" height="100" style="display:none;"></canvas>

<script>
const v = document.getElementById('v');
const c = document.getElementById('c');
const clickArea = document.getElementById('clickArea');
let socket;

// ğŸ”Š èª­ã¿ä¸Šã’é–¢æ•°
function speak(text) {
  window.speechSynthesis.cancel();
  const uttr = new SpeechSynthesisUtterance(text);
  uttr.lang = 'ja-JP';
  uttr.rate = 1.0;
  uttr.pitch = 1.0;
  window.speechSynthesis.speak(uttr);
}

clickArea.addEventListener('click', async () => {
  const id = document.getElementById('targetId').value.trim();
  if (!id) return;

  // iOSéŸ³å£°ãƒ­ãƒƒã‚¯è§£é™¤
  speak("ã‚·ã‚¹ãƒ†ãƒ ã‚’èµ·å‹•ã—ã¾ã™ã€‚");

  // ãƒ€ãƒŸãƒ¼æ˜ åƒï¼ˆPiPç”¨ï¼‰
  v.srcObject = c.captureStream();
  await v.play();
  if (v.webkitSetPresentationMode) {
    v.webkitSetPresentationMode("picture-in-picture");
  }

  // Socketå†æ¥ç¶š
  if (socket) socket.disconnect();

  socket = io("https://mactok-engine.onrender.com", {
    transports: ["websocket"]
  });

  socket.on('connect', () => {
    speak("ã‚µãƒ¼ãƒãƒ¼ã«æ¥ç¶šã—ã¾ã—ãŸã€‚");
    socket.emit('start', id);
  });

  // ğŸ”” ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ï¼ˆæˆåŠŸãƒ»ã‚¨ãƒ©ãƒ¼ï¼‰
  socket.on('status', msg => {
    speak(msg);
  });

  // ğŸ’¬ ã‚³ãƒ¡ãƒ³ãƒˆèª­ã¿ä¸Šã’
  socket.on('chat', data => {
    speak(`${data.user}ã•ã‚“ã€${data.text}`);
  });

  // ğŸ ã‚®ãƒ•ãƒˆï¼ˆç°¡æ˜“ï¼‰
  socket.on('gift', data => {
    speak(`${data.user}ã•ã‚“ã‹ã‚‰${data.gift}ã‚’${data.count}å€‹ï¼`);
  });
});
</script>
</body>
</html>
