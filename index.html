<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MacTok Pro Premium</title>
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <style>
        body { font-family: sans-serif; background: #000; color: #fff; margin: 0; padding: 10px; overflow-x: hidden; }
        .header { display: flex; justify-content: space-between; padding: 5px; border-bottom: 1px solid #333; }
        .timer { color: #00f2ea; font-family: monospace; font-size: 1.2rem; }
        .controls { display: flex; gap: 5px; margin: 10px 0; flex-wrap: wrap; }
        input { flex: 1; min-width: 120px; padding: 12px; border-radius: 8px; background: #111; color: #fff; border: 1px solid #444; }
        button { padding: 12px; border-radius: 8px; border: none; background: #ff0050; color: #fff; font-weight: bold; }
        #log { height: 60vh; overflow-y: auto; border: 1px solid #222; margin-top: 10px; display: flex; flex-direction: column-reverse; }
        .comment { padding: 8px; border-bottom: 1px solid #111; font-size: 0.9rem; line-height: 1.4; }
        .user { color: #00f2ea; font-weight: bold; }
        .gift-msg { background: linear-gradient(45deg, #ff0050, #9000ff); padding: 10px; border-radius: 8px; margin: 5px; border: 1px solid #fff; font-weight: bold; }
    </style>
</head>
<body>
    <div class="header">
        <div id="status">ğŸ”´ æœªæ¥ç¶š</div>
        <div class="timer" id="timer">00:00:00</div>
    </div>

    <div class="controls">
        <input type="text" id="targetId" placeholder="TikTok ID (@ãªã—)">
        <button onclick="startService()">ğŸš€ é–‹å§‹ & éŸ³å£°ON</button>
        <button onclick="togglePiP()" id="pipBtn" style="background: #444;">ğŸ“º å°çª“è¡¨ç¤º</button>
    </div>

    <div id="log"></div>

    <canvas id="pipCanvas" width="400" height="500" style="display:none;"></canvas>
    <video id="pipVideo" autoplay muted playsinline style="position:fixed; top:-100px; left:-100px; width:10px; height:10px;"></video>

    <script>
        const WS_URL = "https://mactok-engine.onrender.com";
        let socket, startTime, timerInterval;
        let isStarted = false;
        let messages = [];

        const canvas = document.getElementById('pipCanvas');
        const ctx = canvas.getContext('2d');
        const video = document.getElementById('pipVideo');

        // åˆæœŸåŒ–ã¨é–‹å§‹ã‚’ä¸€æ‹¬ã§è¡Œã†
        async function startService() {
            if (isStarted) return;
            
            // éŸ³å£°ã®è¨±å¯
            const u = new SpeechSynthesisUtterance("ã‚·ã‚¹ãƒ†ãƒ ã‚’èµ·å‹•ã—ã¾ã—ãŸ");
            u.lang = 'ja-JP';
            window.speechSynthesis.speak(u);

            // ãƒ€ãƒŸãƒ¼æ˜ åƒã®é–‹å§‹ï¼ˆPiPç”¨ï¼‰
            const stream = canvas.captureStream(10);
            video.srcObject = stream;
            try { await video.play(); } catch(e) {}

            const id = document.getElementById('targetId').value.trim();
            if(!id) { alert("IDã‚’å…¥åŠ›ã—ã¦ãã ã•ã„"); return; }

            connect(id);
            isStarted = true;
            document.getElementById('status').innerText = "ğŸŸ¡ æº–å‚™ä¸­...";
        }

        function speak(text) {
            const u = new SpeechSynthesisUtterance(text);
            u.lang = 'ja-JP';
            u.rate = 1.3;
            window.speechSynthesis.speak(u);
        }

        function connect(id) {
            socket = io(WS_URL);
            socket.on('connect', () => {
                socket.emit('start', id);
                document.getElementById('status').innerText = "ğŸŸ¢ æ¥ç¶šä¸­";
                startTime = new Date();
                timerInterval = setInterval(() => { 
                    updateTimer(); 
                    drawCanvas(); 
                }, 1000);
            });

            socket.on('chat', data => {
                addLog(`<div class="comment"><span class="user">${data.user}</span>: ${data.text}</div>`, `${data.user}: ${data.text}`);
                speak(`${data.user}ã•ã‚“ã€${data.text}`);
            });

            socket.on('gift', data => {
                const msg = `ğŸ ${data.user}ãŒ${data.gift}ã‚’è´ˆã‚Šã¾ã—ãŸï¼`;
                addLog(`<div class="gift-msg">${msg}</div>`, msg);
                speak(msg);
            });
        }

        function updateTimer() {
            const diff = Math.floor((new Date() - startTime) / 1000);
            const h = String(Math.floor(diff / 3600)).padStart(2, '0');
            const m = String(Math.floor((diff % 3600) / 60)).padStart(2, '0');
            const s = String(diff % 60).padStart(2, '0');
            document.getElementById('timer').innerText = `${h}:${m}:${s}`;
        }

        function addLog(html, text) {
            document.getElementById('log').insertAdjacentHTML('afterbegin', html);
            messages.unshift(text);
            if(messages.length > 15) messages.pop();
        }

        function drawCanvas() {
            ctx.fillStyle = "#000";
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            ctx.fillStyle = "#00f2ea";
            ctx.font = "bold 22px Arial";
            ctx.fillText("MacTok Monitor", 15, 40);
            ctx.fillStyle = "#fff";
            ctx.font = "16px Arial";
            messages.forEach((m, i) => {
                ctx.fillText(m, 15, 80 + (i * 28));
            });
        }

        async function togglePiP() {
            try {
                if (document.pictureInPictureElement) {
                    await document.exitPictureInPicture();
                } else {
                    await video.requestPictureInPicture();
                }
            } catch (err) {
                alert("ãƒ–ãƒ©ã‚¦ã‚¶ã‚’ä¸€åº¦ã‚¿ãƒƒãƒ—ã—ã¦ã‹ã‚‰ã€Œå°çª“è¡¨ç¤ºã€ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚");
            }
        }
    </script>
</body>
</html>
