<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0">
    <title>TikTok 読み上げ【最終修正版】</title>
    <style>
        body { background:#000; color:#fff; text-align:center; font-family:sans-serif; padding:20px; }
        .box { background:#1a1a1a; padding:15px; border-radius:15px; border:2px solid #00f2ea; }
        button { padding:20px; width:90%; background:#ff0050; color:#fff; border-radius:10px; font-weight:bold; font-size:20px; border:none; margin-top:10px; }
        #log { background:#111; height:300px; overflow-y:auto; margin-top:20px; padding:10px; text-align:left; font-size:12px; border-radius:10px; }
        video { width:100px; height:50px; position:fixed; bottom:0; right:0; opacity:0.1; pointer-events:none; }
    </style>
</head>
<body>
    <div class="box">
        <h3>TikTok 読み上げ君</h3>
        <input type="text" id="i" value="genkai_inpeita" style="padding:10px; width:80%; font-size:18px;">
        <button id="mainBtn">小窓起動 ＆ 接続開始</button>
        <div id="status" style="margin-top:10px; color:#ffdd00;">【重要】ボタンを押すと小窓が出ます</div>
    </div>
    <video id="v" playsinline muted loop></video>
    <div id="log">ログを表示...</div>

    <script src="https://unpkg.com/tiktok-live-connect@0.1.1/dist/browser/tiktok-live-connect.min.js"></script>
    <script>
        const v = document.getElementById('v');
        const mainBtn = document.getElementById('mainBtn');
        const log = document.getElementById('log');

        function addLog(m) { const d=document.createElement('div'); d.innerText=`[${new Date().toLocaleTimeString()}] ${m}`; log.prepend(d); }

        mainBtn.onclick = async () => {
            addLog("ボタンが押されました。処理開始...");
            
            // 1. 小窓を出す（これがないと裏で止まる）
            try {
                const canvas = document.createElement('canvas');
                canvas.width = 100; canvas.height = 100;
                const ctx = canvas.getContext('2d');
                ctx.fillStyle = "red"; ctx.fillRect(0,0,100,100);
                v.srcObject = canvas.captureStream();
                await v.play();
                await v.requestPictureInPicture();
                addLog("✅ 小窓OK！");
            } catch (e) {
                addLog("❌ 小窓失敗。設定を確認してください。");
            }

            // 2. 接続開始（外部部品がなくてもエラーにならないように保護）
            if (typeof TikTokLiveConnector === 'undefined') {
                addLog("❌ まだ部品が読み込まれていません。10秒待って。");
                return;
            }

            const tid = document.getElementById('i').value;
            try {
                const con = new TikTokLiveConnector.WebcastPushConnection(tid);
                con.connect().then(() => {
                    addLog("✅ 接続完了！読み上げます。");
                    window.speechSynthesis.speak(new SpeechSynthesisUtterance("接続成功"));
                }).catch(e => addLog("❌ IDミスか配信外です。"));

                con.on('chat', data => {
                    addLog(data.nickname + ":" + data.comment);
                    const u = new SpeechSynthesisUtterance(data.nickname + "さん " + data.comment);
                    u.lang = 'ja-JP';
                    window.speechSynthesis.speak(u);
                });
            } catch (e) { addLog("エラー:" + e.message); }
        };
    </script>
</body>
</html>
