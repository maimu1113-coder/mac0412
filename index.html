<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mac Talk PRO</title>
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
</head>
<body style="background:#000; color:#fff; text-align:center; padding-top:50px;">
    <h1>Mac Talk PRO</h1>
    <input type="text" id="targetId" placeholder="TikTok ID" style="padding:15px; width:80%; font-size:16px;">
    <br><br>
    <button id="startBtn" style="padding:20px 40px; font-size:20px; background:#00f2ea; border-radius:15px;">SYSTEM START</button>

    <video id="v" autoplay muted playsinline loop style="position:fixed;top:-100px;width:1px;height:1px;"></video>
    <canvas id="c" width="100" height="100" style="display:none;"></canvas>

    <script>
        const v = document.getElementById('v');
        const c = document.getElementById('c');
        const ctx = c.getContext('2d');

        function speak(text) {
            const uttr = new SpeechSynthesisUtterance(text);
            uttr.lang = 'ja-JP';
            uttr.rate = 1.2;
            uttr.volume = 1.0; // 音量を最大に設定
            window.speechSynthesis.cancel();
            window.speechSynthesis.speak(uttr);
        }

        document.getElementById('startBtn').addEventListener('click', async () => {
            // ボタンを押した瞬間に一回しゃべらせる（音のロック解除）
            speak("システム起動");

            const id = document.getElementById('targetId').value.trim();
            if(!id) return;

            // 小窓起動
            v.srcObject = c.captureStream();
            await v.play();
            if (v.webkitSetPresentationMode) {
                v.webkitSetPresentationMode("picture-in-picture");
            }

            const socket = io("https://mactok-engine.onrender.com", { transports: ['websocket'] });
            
            socket.on('connect', () => {
                setTimeout(() => speak("サーバーに接続しました。コメントを待機します"), 1000);
            });

            socket.on('chat', data => {
                speak(data.user + "さん。" + data.text);
            });

            socket.emit('start', id);
        });
    </script>
</body>
</html>
