<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Mac Talk PRO</title>
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
</head>
<body style="background:#000; color:#fff; text-align:center; padding-top:50px; font-family:sans-serif;">
    <h1 style="color:#00f2ea;">Mac Talk PRO</h1>
    <input type="text" id="targetId" placeholder="TikTok ID" value="macrecords1" style="padding:15px; width:80%; font-size:16px; border-radius:10px; margin-bottom:20px;">
    <br>
    
    <div id="clickArea" style="margin:20px auto; width:200px; height:200px; background:#ff0050; border-radius:50%; display:flex; align-items:center; justify-content:center; cursor:pointer;">
        <span style="font-size:24px; font-weight:bold; color:#fff;">START</span>
    </div>

    <video id="v" playsinline muted autoplay style="width:150px; height:150px; margin:20px auto; background:#222; border:2px solid #00f2ea;"></video>
    <canvas id="c" width="100" height="100" style="display:none;"></canvas>

    <script>
        const v = document.getElementById('v');
        const c = document.getElementById('c');
        const clickArea = document.getElementById('clickArea');

        function speak(text) {
            const uttr = new SpeechSynthesisUtterance(text);
            uttr.lang = 'ja-JP';
            window.speechSynthesis.cancel();
            window.speechSynthesis.speak(uttr);
        }

        clickArea.addEventListener('click', async (e) => {
            e.preventDefault(); // 画面がどこかへ飛ぶのを防ぐ
            
            const id = document.getElementById('targetId').value.trim();
            speak("起動します。");

            // 動画をその場で再生（小窓の準備）
            v.srcObject = c.captureStream();
            await v.play();
            
            // iPhone専用：小窓ボタンを出す
            if (v.webkitSetPresentationMode) {
                v.webkitSetPresentationMode("picture-in-picture");
            }

            // サーバー接続
            const socket = io("https://mactok-engine.onrender.com", { transports: ['websocket'] });
            socket.on('connect', () => {
                setTimeout(() => speak("接続しました。コメントを待機します"), 1000);
            });
            socket.on('chat', data => {
                speak(data.user + "さん、" + data.text);
            });
            socket.emit('start', id);
        });
    </script>
</body>
</html>
