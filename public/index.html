<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Mac Talk PRO</title>
<script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>

<style>
.subtitle {
  font-size: 32px;
  color: #fff;
  background: rgba(0,0,0,0.6);
  padding: 12px 20px;
  border-radius: 12px;
  opacity: 0;
}
.subtitle.show {
  animation: fade 5s ease forwards;
}
@keyframes fade {
  0% {opacity:0; transform:translateY(20px);}
  10% {opacity:1; transform:translateY(0);}
  90% {opacity:1;}
  100% {opacity:0;}
}
</style>
</head>

<body style="background:#000;color:#fff;text-align:center;">
<h1>Mac Talk PRO</h1>

<input id="targetId" placeholder="TikTok ID">
<button id="start">START</button>

<div id="subtitle" class="subtitle"></div>

<!-- PIP維持用 -->
<video id="pipVideo" muted autoplay playsinline loop
 style="width:1px;height:1px;position:fixed;left:-10px;top:-10px;"></video>

<script>
const socket = io();
let speaking = false;
const queue = [];

/* PIP維持 */
const pipVideo = document.getElementById("pipVideo");
const canvas = document.createElement("canvas");
canvas.width = canvas.height = 1;
pipVideo.srcObject = canvas.captureStream();
pipVideo.play().then(()=>{
  if(pipVideo.webkitSetPresentationMode){
    pipVideo.webkitSetPresentationMode("picture-in-picture");
  }
});

/* START */
document.getElementById("start").onclick = () => {
  const id = document.getElementById("targetId").value;
  speechSynthesis.speak(new SpeechSynthesisUtterance("起動します"));
  socket.emit("start", id);
};

/* 音声キュー */
socket.on("voice", b64 => {
  queue.push(b64);
  if (!speaking) playNext();
});

function playNext(){
  if(queue.length === 0){
    speaking = false;
    return;
  }
  speaking = true;
  const audio = new Audio("data:audio/wav;base64," + queue.shift());
  audio.onended = playNext;
  audio.play();
}

/* 字幕 */
socket.on("subtitle", text => {
  const el = document.getElementById("subtitle");
  el.innerText = text;
  el.classList.remove("show");
  void el.offsetWidth;
  el.classList.add("show");
});

/* Ping */
setInterval(()=>socket.emit("ping"),20000);
</script>
</body>
</html>
