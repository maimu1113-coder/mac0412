<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Mac Talk PRO</title>
  <script src="/socket.io/socket.io.js"></script>
  <style>
    body { background: #000; color: #fff; font-family: sans-serif; text-align: center; margin: 0; padding: 20px; }
    h1 { color: #00f2ea; font-size: 28px; }
    input { padding: 15px; width: 85%; font-size: 18px; border-radius: 12px; border: none; margin-bottom: 20px; }
    #start { 
      margin: 20px auto; width: 160px; height: 160px; background: #ff0050; 
      border-radius: 50%; display: flex; align-items: center; justify-content: center; 
      font-size: 26px; font-weight: bold; cursor: pointer; box-shadow: 0 0 20px rgba(255,0,80,0.5);
    }
    #status { color: #00f2ea; margin-bottom: 10px; }
    #log { font-size: 14px; color: #888; height: 150px; overflow: hidden; }
    video { width: 1px; height: 1px; opacity: 0; position: absolute; }
  </style>
</head>
<body>

  <h1>Mac Talk PRO</h1>
  <p id="status">å¾…æ©Ÿä¸­...</p>
  
  <input id="targetId" type="text" placeholder="TikTok ID (@æŠœã)" />

  <div id="start">START</div>

  <video id="pip" playsinline muted autoplay></video>

  <div id="log"></div>

  <script>
    const socket = io();
    const pipVideo = document.getElementById("pip");
    const startBtn = document.getElementById("start");
    const statusText = document.getElementById("status");

    // çµµæ–‡å­—ã‚’é™¤å»ã™ã‚‹æ­£è¦è¡¨ç¾
    function removeEmoji(text) {
      return text.replace(/([\u2700-\u27BF]|[\uE000-\uF8FF]|\uD83C[\uDC00-\uDFFF]|\uD83D[\uDC00-\uDFFF]|[\u2011-\u26FF]|\uD83E[\uDD10-\uDDFF])/g, '');
    }

    // èª­ã¿ä¸Šã’é–¢æ•°ï¼ˆã‚­ãƒ¥ãƒ¼ã‚¤ãƒ³ã‚°å¯¾å¿œï¼‰
    function speak(text) {
      if (pipVideo.paused) pipVideo.play(); // iOSç”¨å†ç”Ÿç¶­æŒ

      const uttr = new SpeechSynthesisUtterance(text);
      uttr.lang = "ja-JP";
      uttr.rate = 1.2; // æºœã¾ã‚‰ãªã„ã‚ˆã†å°‘ã—é€Ÿã‚
      
      // å‰ã®éŸ³å£°ã‚’æ¶ˆã•ãšã€é †ç•ªã«æœ€å¾Œã¾ã§èª­ã¿åˆ‡ã‚‹ï¼ˆcancelã‚’å‘¼ã°ãªã„ï¼‰
      window.speechSynthesis.speak(uttr);
    }

    // PiPï¼ˆãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰å†ç”Ÿï¼‰ã®æœ‰åŠ¹åŒ–
    async function enablePiP() {
      const canvas = Object.assign(document.createElement("canvas"), { width: 10, height: 10 });
      canvas.getContext("2d").fillRect(0, 0, 10, 10);
      pipVideo.srcObject = canvas.captureStream(1);
      await pipVideo.play();

      if (pipVideo.webkitSetPresentationMode) {
        await pipVideo.webkitSetPresentationMode("picture-in-picture");
      } else if (document.pictureInPictureEnabled) {
        await pipVideo.requestPictureInPicture();
      }
    }

    startBtn.onclick = async () => {
      const id = document.getElementById("targetId").value.trim();
      if (!id) return alert("TikTok IDã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");

      try {
        await enablePiP();
        statusText.innerText = "æ¥ç¶šä¸­...";
        speak("ã‚·ã‚¹ãƒ†ãƒ ã‚’èµ·å‹•ã—ã¾ã™ã€‚");
        socket.emit("start", id);
      } catch (e) {
        alert("èµ·å‹•ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒ–ãƒ©ã‚¦ã‚¶ã®è¨­å®šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚");
      }
    };

    // ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹é€šçŸ¥
    socket.on("status", s => { statusText.innerText = s; });

    // ã‚³ãƒ¡ãƒ³ãƒˆå—ä¿¡ï¼šåå‰ã¯èª­ã¾ãšã€çµµæ–‡å­—ã‚’é™¤å»ã—ã¦èª­ã¿åˆ‡ã‚‹
    socket.on("chat", data => {
      const cleanMsg = removeEmoji(data.text);
      if (cleanMsg.trim()) {
        speak(cleanMsg);
        addLog(cleanMsg);
      }
    });

    // ã‚®ãƒ•ãƒˆå—ä¿¡ï¼šã™ã¹ã¦ã€Œãƒãƒªãƒ¼ãƒ³ï¼ã€ã§çµ±ä¸€
    socket.on("gift_event", () => {
      speak("ãƒãƒªãƒ¼ãƒ³ï¼");
      addLog("ğŸ ã‚®ãƒ•ãƒˆå—è¨ºï¼šãƒãƒªãƒ¼ãƒ³ï¼");
    });

    function addLog(msg) {
      const log = document.getElementById("log");
      log.innerHTML = `<div>${msg}</div>` + log.innerHTML;
    }
  </script>
</body>
</html>
