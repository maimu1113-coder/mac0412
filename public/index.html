<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>Mac Talk PRO Safari</title>
<script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
</head>

<body style="background:#000;color:#fff;text-align:center;font-family:sans-serif;">
<h2 style="color:#00f2ea;">Mac Talk PRO</h2>

<input id="targetId" placeholder="TikTok ID"
style="padding:14px;width:80%;font-size:16px;border-radius:10px;">

<div id="start"
style="margin:20px auto;width:160px;height:160px;
background:#ff0050;border-radius:50%;
display:flex;align-items:center;justify-content:center;
font-size:22px;font-weight:bold;cursor:pointer;">
START
</div>

<!-- PIPç”¨ -->
<video id="pipVideo" playsinline muted autoplay
style="width:1px;height:1px;opacity:0"></video>

<div id="log" style="padding:10px;"></div>

<script>
const socket = io();
const log = document.getElementById("log");
const startBtn = document.getElementById("start");
const pipVideo = document.getElementById("pipVideo");

/* ===== çµµæ–‡å­—é™¤å» ===== */
function clean(text){
 return text.replace(/[\p{Emoji_Presentation}\p{Extended_Pictographic}]/gu,'').trim();
}

/* ===== èª­ã¿ä¸Šã’ã‚­ãƒ¥ãƒ¼ ===== */
let queue=[];
let speaking=false;

function speakQueue(text){
 queue.push(text);
 if(!speaking) next();
}

function next(){
 if(queue.length===0){speaking=false;return;}
 speaking=true;
 const t=queue.shift();

 const u=new SpeechSynthesisUtterance(t);
 u.lang="ja-JP";
 u.rate=0.95;
 u.pitch=1.1;

 u.onend=()=>next();
 speechSynthesis.speak(u);
}

/* ===== PIPèµ·å‹• ===== */
async function enablePIP(){
 const stream=new MediaStream();
 pipVideo.srcObject=stream;
 await pipVideo.play();
 if(pipVideo.webkitSetPresentationMode){
   pipVideo.webkitSetPresentationMode("picture-in-picture");
 }
}

/* ===== START ===== */
startBtn.onclick=async()=>{
 const id=document.getElementById("targetId").value.trim();
 if(!id) return alert("TikTok IDã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");

 await enablePIP();
 speakQueue("æ¥ç¶šã—ã¾ã™");
 socket.emit("start",id);
};

/* ===== socket ===== */
socket.on("status",s=>{
 log.innerHTML+=`<p>ğŸ“¡ ${s}</p>`;
});

socket.on("chat",d=>{
 const user=clean(d.user);
 const text=clean(d.text);
 log.innerHTML+=`<p>${user}ï¼š${text}</p>`;
 speakQueue(`${user}ã•ã‚“ã€‚${text}`);
});

socket.on("gift",d=>{
 const user=clean(d.user);
 const gift=clean(d.giftName);
 const t=`${user}ã•ã‚“ã‹ã‚‰${gift}ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™`;
 log.innerHTML+=`<p style="color:yellow">ğŸ ${t}</p>`;
 speakQueue(t);
});
</script>
</body>
</html>
