<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>Mac Talk PRO FINAL</title>
    <script src="/socket.io/socket.io.js"></script>
    <style>
        :root { --primary: #00f2ea; --bg: #0d0d0d; --card: #1a1a1a; }
        body { font-family: -apple-system, sans-serif; background: var(--bg); color: white; margin: 0; padding: env(safe-area-inset-top) 15px 20px; }
        .mactalk-logo { font-size: 2.5rem; font-weight: 900; text-align: center; color: var(--primary); margin: 30px 0; }
        .voice-btn { background: #ff0050; color: white; border: none; padding: 20px; border-radius: 12px; font-weight: bold; width: 100%; margin-bottom: 15px; font-size: 1.2rem; }
        .voice-btn.active { background: #333; color: var(--primary); }
        .input-group { display: flex; gap: 8px; margin-bottom: 15px; }
        input { flex: 1; background: var(--card); border: 1px solid #333; padding: 15px; border-radius: 10px; color: white; outline: none; }
        .connect-btn { background: var(--primary); border: none; padding: 0 20px; border-radius: 10px; font-weight: bold; }
        .status-card { background: var(--card); padding: 15px; border-radius: 15px; display: flex; align-items: center; gap: 15px; margin-bottom: 15px; border: 1px solid #333; }
        #avatar { width: 50px; height: 50px; border-radius: 50%; border: 2px solid var(--primary); }
        #chats { display: flex; flex-direction: column-reverse; gap: 10px; }
        .chat-card { background: var(--card); padding: 12px; border-radius: 12px; border-left: 5px solid var(--primary); }
    </style>
</head>
<body>
    <audio id="bgTracker" loop playsinline src="https://github.com/anars/blank-audio/raw/master/10-minutes-of-silence.mp3"></audio>
    <div class="mactalk-logo">Mac Talk</div>
    <button id="voiceInit" class="voice-btn">⚡ 読み上げを開始する</button>
    <div class="input-group">
        <input id="userId" placeholder="TikTok ID (@なし)">
        <button class="connect-btn" onclick="connect()">接続</button>
    </div>
    <div class="status-card">
        <img id="avatar" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7">
        <div><div id="hostName" style="font-weight:bold;">未接続</div><div id="statusText" style="font-size:0.8rem;color:#777;">IDを入力してください</div></div>
    </div>
    <div id="chats"></div>

    <script>
        const socket = io();
        let voiceEnabled = false;

        // iPhoneの音声ロックを解除するための処理
        document.getElementById('voiceInit').addEventListener('click', async function() {
            voiceEnabled = true;
            this.classList.add('active');
            this.innerText = "⚡ システム稼働中";
            
            // 無音再生を開始
            const bg = document.getElementById('bgTracker');
            bg.play().catch(() => {
                alert("もう一度ボタンを押してください。音が許可されませんでした。");
            });

            // 起動テスト
            speak("システム、オールグリーン。読み上げの準備ができました。");
        });

        function connect() {
            const id = document.getElementById('userId').value;
            if(!id) return;
            socket.emit("setTargetUser", id);
        }

        socket.on('roomInfo', data => {
            document.getElementById('avatar').src = data.avatar;
            document.getElementById('hostName').innerText = data.nickname;
            document.getElementById('statusText').innerText = "✅ ライブ接続中";
            speak("接続成功。読み上げを開始します。");
        });

        socket.on('chat', data => {
            const card = document.createElement('div');
            card.className = 'chat-card';
            card.innerHTML = `<b>@${data.nickname}</b><br>${data.comment}`;
            document.getElementById('chats').prepend(card);
            
            // 読み上げ実行
            if(voiceEnabled) {
                speak(data.nickname + "さん、" + data.comment);
            }
        });

        // iPhoneで確実に音を出すための関数
        function speak(text) {
            if(!voiceEnabled) return;
            
            // 読み上げ停止を防ぐためのキャンセル
            window.speechSynthesis.cancel(); 

            const uttr = new SpeechSynthesisUtterance(text);
            uttr.lang = 'ja-JP';
            uttr.rate = 1.2; // 少し早口に設定
            uttr.pitch = 1.0;
            
            window.speechSynthesis.speak(uttr);
        }

        // 画面のどこかを触るたびに音声エンジンをリセット（iPhone対策）
        document.body.addEventListener('touchstart', () => {
            window.speechSynthesis.resume();
        });
    </script>
</body>
</html>
