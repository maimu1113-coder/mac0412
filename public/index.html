<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>Mac Talk PRO ULTIMATE</title>
    <script src="/socket.io/socket.io.js"></script>
    <style>
        :root { --primary: #00f2ea; --secondary: #ff0050; --bg: #0d0d0d; --card: #1a1a1a; --gift: #ffac33; }
        body { font-family: -apple-system, sans-serif; background: var(--bg); color: white; margin: 0; padding: env(safe-area-inset-top) 15px 20px; height: 100vh; display: flex; flex-direction: column; box-sizing: border-box; overflow: hidden; }
        .mactalk-logo { font-size: 2.5rem; font-weight: 900; text-align: center; background: linear-gradient(90deg, #fff, var(--primary), #fff); -webkit-background-clip: text; -webkit-text-fill-color: transparent; margin-top: 30px; }
        .voice-btn { background: var(--secondary); color: white; border: none; padding: 15px; border-radius: 12px; font-weight: bold; width: 100%; margin-bottom: 10px; }
        .voice-btn.active { background: #333; color: var(--primary); }
        .input-group { display: flex; gap: 8px; margin-bottom: 10px; }
        input { flex: 1; background: var(--card); border: 1px solid #333; padding: 12px; border-radius: 10px; color: white; outline: none; }
        .connect-btn { background: var(--primary); border: none; padding: 0 20px; border-radius: 10px; font-weight: bold; color: #000; }
        #chats { flex: 1; overflow-y: auto; display: flex; flex-direction: column-reverse; gap: 8px; }
        .chat-card { background: var(--card); padding: 12px; border-radius: 12px; border-left: 5px solid var(--primary); animation: slideIn 0.3s ease; }
        .gift-card { background: rgba(255, 172, 51, 0.1); border-left: 5px solid var(--gift); padding: 12px; border-radius: 12px; animation: giftPop 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        @keyframes slideIn { from { transform: translateX(-10px); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        @keyframes giftPop { from { transform: scale(0.8); opacity: 0; } to { transform: scale(1); opacity: 1; } }
    </style>
</head>
<body>
    <audio id="bgTracker" loop playsinline src="https://github.com/anars/blank-audio/raw/master/10-minutes-of-silence.mp3"></audio>
    <div class="mactalk-logo">Mac Talk</div>
    <button id="voiceInit" class="voice-btn">âš¡ ãƒ¢ãƒ‹ã‚¿ãƒ¼é–‹å§‹</button>
    <div class="input-group">
        <input id="userId" placeholder="TikTok ID">
        <button class="connect-btn" onclick="connect()">æ¥ç¶š</button>
    </div>
    <div id="chats"></div>

    <script>
        const socket = io();
        let voiceEnabled = false, speechQueue = [], isSpeaking = false, audioCtx;
        let isMuted = false;

        async function keepAlive() {
            if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            if (audioCtx.state === 'suspended') await audioCtx.resume();
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            gain.gain.value = 0.0001;
            osc.connect(gain); gain.connect(audioCtx.destination);
            osc.start(); osc.stop(audioCtx.currentTime + 0.1);
        }

        document.getElementById('voiceInit').addEventListener('click', async function() {
            voiceEnabled = true;
            this.classList.add('active'); this.innerText = "âš¡ ã‚·ã‚¹ãƒ†ãƒ ç¨¼åƒä¸­ (ãƒã‚¤ã‚¯å¾…æ©Ÿ)";
            await document.getElementById('bgTracker').play();
            setInterval(keepAlive, 1000);
            speak("ã‚ªãƒ¼ãƒ«ã‚·ã‚¹ãƒ†ãƒ ãƒ»ã‚ªãƒ³ãƒ©ã‚¤ãƒ³ã€‚");
        });

        function connect() {
            const id = document.getElementById('userId').value;
            if(!id) return;
            socket.emit("setTargetUser", id);
        }

        // ã‚³ãƒ¡ãƒ³ãƒˆå—ä¿¡
        socket.on('chat', data => {
            // ã‚³ãƒãƒ³ãƒ‰å‡¦ç†
            if (data.isCommand) {
                if (data.comment === "!stop") { isMuted = true; speak("èª­ã¿ä¸Šã’ã‚’åœæ­¢ã—ã¾ã™"); return; }
                if (data.comment === "!start") { isMuted = false; speak("èª­ã¿ä¸Šã’ã‚’å†é–‹ã—ã¾ã™"); return; }
            }

            const card = document.createElement('div');
            card.className = 'chat-card';
            card.innerHTML = `<b style="color:var(--primary)">@${data.nickname}</b><br>${data.comment}`;
            document.getElementById('chats').prepend(card);
            
            if(voiceEnabled && !isMuted) {
                const n = data.nickname.replace(/[^\u3041-\u3096\u30A1-\u30F6\u4E00-\u9FFF0-9A-Za-z]/g, '');
                const m = data.comment.replace(/[^\u3041-\u3096\u30A1-\u30F6\u4E00-\u9FFF0-9A-Za-z]/g, '');
                if(m) speak(`${n}ã€${m}`);
            }
        });

        // ã‚®ãƒ•ãƒˆå—ä¿¡
        socket.on('gift', data => {
            const card = document.createElement('div');
            card.className = 'gift-card';
            card.innerHTML = `<b style="color:var(--gift)">ğŸ ${data.nickname}ã•ã‚“</b><br>${data.giftName} Ã— ${data.repeatCount}`;
            document.getElementById('chats').prepend(card);
            
            if(voiceEnabled) {
                speak(`${data.nickname}ã•ã‚“ã€${data.giftName}ã‚ã‚ŠãŒã¨ã†ï¼`);
            }
        });

        function speak(t) {
            if(!voiceEnabled) return;
            const u = new SpeechSynthesisUtterance(t);
            u.lang = 'ja-JP'; u.rate = 1.3;
            u.onend = () => { isSpeaking = false; process(); };
            speechQueue.push(u);
            if(!isSpeaking) process();
        }

        function process() {
            if(speechQueue.length === 0) return;
            isSpeaking = true;
            window.speechSynthesis.speak(speechQueue.shift());
        }

        document.body.addEventListener('click', () => { if(audioCtx) audioCtx.resume(); });
    </script>
</body>
</html>
