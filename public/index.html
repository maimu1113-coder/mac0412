<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0,viewport-fit=cover">
<title>Mac Talk PRO</title>
<script src="/socket.io/socket.io.js"></script>
<style>
:root{--bg:#0b0e14;--side:#161920;--card:#1f232d;--accent:#00f2ea;--pink:#ff0050}
body{font-family:sans-serif;background:var(--bg);color:#fff;margin:0;display:flex;height:100vh;overflow:hidden}
.sidebar{width:60px;min-width:60px;background:var(--side);display:flex;flex-direction:column;align-items:center;padding-top:30px;gap:25px;border-right:1px solid #333}
.main{flex:1;display:flex;flex-direction:column;padding:15px;overflow:hidden}
.card{background:var(--card);padding:15px;border-radius:12px;margin-bottom:10px;border:1px solid #444}
input{width:100%;padding:15px;background:#000;border:1px solid #555;color:#fff;border-radius:8px;box-sizing:border-box;font-size:18px;margin-bottom:10px}
button{width:100%;padding:16px;border-radius:10px;border:none;font-weight:bold;margin-bottom:10px;font-size:16px}
.btn-pink{background:var(--pink);color:#fff}
.btn-blue{background:var(--accent);color:#000}
#log-area{flex:1;overflow-y:auto;display:flex;flex-direction:column;gap:8px;padding:10px;background:rgba(255,255,255,0.02);border-radius:8px}
.log-item{background:var(--card);padding:12px;border-radius:8px;border-left:4px solid var(--accent);font-size:0.9rem;color:#fff}
</style>
</head>
<body>

<div class="sidebar"><div style="font-size:1.5rem">ğŸ </div></div>

<div class="main">
    <div style="display:flex;justify-content:space-between;margin-bottom:10px">
        <h2 style="margin:0">Mac Talk <span style="color:var(--accent)">PRO</span></h2>
        <div style="background:#222;padding:4px 10px;border-radius:15px;font-size:0.8rem">ğŸ‘ï¸ <span id="vCount">0</span></div>
    </div>
    
    <div class="card">
        <input id="tid" placeholder="TikTok IDã‚’å…¥åŠ›">
        <button class="btn-pink" onclick="handleStart()">1. èª­ã¿ä¸Šã’ã‚’æœ‰åŠ¹ã«ã™ã‚‹</button>
        <button class="btn-blue" onclick="handleConnect()">2. ä¿å­˜ã—ã¦ãƒ©ã‚¤ãƒ–æ¥ç¶š</button>
    </div>

    <div id="log-area">
        <div class="log-item">ã‚·ã‚¹ãƒ†ãƒ ï¼šå¾…æ©Ÿä¸­...</div>
    </div>
</div>

<audio id="bg-audio" loop playsinline style="display:none">
    <source src="https://raw.githubusercontent.com/anars/blank-audio/master/10-seconds-of-silence.mp3" type="audio/mp3">
</audio>

<script>
const socket = io();
let isEngineOn = false;
let speechQueue = [];
let isSpeaking = false;
const logArea = document.getElementById("log-area");

// 1. èª­ã¿ä¸Šã’æœ‰åŠ¹åŒ–ãƒœã‚¿ãƒ³
function handleStart() {
    isEngineOn = true;
    const audio = document.getElementById("bg-audio");
    
    // ç„¡éŸ³éŸ³å£°ã‚’å†ç”Ÿï¼ˆã“ã‚Œã§ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ã‚»ãƒ³ã‚¿ãƒ¼ã«ãƒ­ã‚´ãŒå‡ºã¾ã™ï¼‰
    audio.play().then(() => {
        addLog("âœ… ã‚·ã‚¹ãƒ†ãƒ ï¼šãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰éŸ³å£°é–‹å§‹");
    }).catch(e => {
        addLog("âŒ ã‚¨ãƒ©ãƒ¼ï¼šãƒ–ãƒ©ã‚¦ã‚¶ãŒéŸ³å£°ã‚’ãƒ–ãƒ­ãƒƒã‚¯ã—ã¾ã—ãŸ");
    });

    const msg = new SpeechSynthesisUtterance("ãƒãƒƒã‚¯ãƒˆãƒ¼ã‚¯ã€æº–å‚™å®Œäº†ã—ã¾ã—ãŸ");
    msg.lang = 'ja-JP';
    window.speechSynthesis.speak(msg);
}

// 2. æ¥ç¶šãƒœã‚¿ãƒ³
function handleConnect() {
    const id = document.getElementById("tid").value.trim();
    if (!id) {
        alert("IDã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
        return;
    }
    
    addLog(`â³ ã‚·ã‚¹ãƒ†ãƒ ï¼š${id} ã«æ¥ç¶šã‚’è¦æ±‚ä¸­...`);
    socket.emit("setTarget", id);
    localStorage.setItem("mtid", id);
}

window.onload = () => {
    const saved = localStorage.getItem("mtid");
    if(saved) document.getElementById("tid").value = saved;
};

// ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰ã®ã‚¤ãƒ™ãƒ³ãƒˆå—ä¿¡ã‚’å¼·åŒ–
socket.on("ev", e => {
    console.log("Recieved:", e); // ãƒ‡ãƒãƒƒã‚°ç”¨
    let l = "";
    let s = "";

    if(e.t === "chat") { l = `ğŸ’¬ ${e.u}: ${e.m}`; s = `${e.u}ã•ã‚“ã€${e.m}`; }
    if(e.t === "follow") { l = `ğŸ‘¤ ${e.u} ãŒãƒ•ã‚©ãƒ­ãƒ¼ï¼`; s = `${e.u}ã•ã‚“ãƒ•ã‚©ãƒ­ãƒ¼ã‚ã‚ŠãŒã¨ã†`; }
    if(e.t === "gift") { l = `ğŸ ${e.u}: ${e.g} x${e.c}`; s = `${e.u}ã•ã‚“${e.g}ã‚ã‚ŠãŒã¨ã†`; }
    if(e.t === "sys") { l = `ğŸ“¢ ${e.m}`; }

    if(l) addLog(l);
    if(s && isEngineOn) {
        speechQueue.push(s);
        processSpeech();
    }
});

socket.on("up-v", c => {
    document.getElementById("vCount").innerText = c;
});

function processSpeech() {
    if(!isEngineOn || isSpeaking || speechQueue.length === 0) return;
    isSpeaking = true;
    const u = new SpeechSynthesisUtterance(speechQueue.shift());
    u.lang = 'ja-JP';
    u.rate = 1.2;
    u.onend = () => { isSpeaking = false; processSpeech(); };
    window.speechSynthesis.speak(u);
}

function addLog(msg) {
    const div = document.createElement("div");
    div.className = "log-item";
    div.innerText = msg;
    logArea.insertBefore(div, logArea.firstChild);
}
</script>
</body>
</html>
