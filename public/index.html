<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0,viewport-fit=cover">
<title>Mac Talk PRO</title>
<script src="/socket.io/socket.io.js"></script>
<style>
:root{--bg:#0b0e14;--side:#161920;--card:#1f232d;--accent:#00f2ea;--pink:#ff0050}
body{font-family:sans-serif;background:var(--bg);color:#fff;margin:0;display:flex;height:100vh;overflow:hidden}
.sidebar{width:60px;min-width:60px;background:var(--side);display:flex;flex-direction:column;align-items:center;padding-top:30px;gap:35px;border-right:1px solid #333}
.side-btn{font-size:1.5rem;cursor:pointer;opacity:0.6}
.main{flex:1;display:flex;flex-direction:column;padding:15px;overflow:hidden}
.card{background:var(--card);padding:15px;border-radius:12px;margin-bottom:10px;border:1px solid #444}
input{width:100%;padding:15px;background:#000;border:1px solid #555;color:#fff;border-radius:8px;box-sizing:border-box;font-size:18px;margin-bottom:12px}
button{width:100%;padding:16px;border-radius:10px;border:none;font-weight:bold;margin-bottom:10px;font-size:16px;cursor:pointer}
.btn-pink{background:var(--pink);color:#fff}
.btn-blue{background:var(--accent);color:#000}
#log-area{flex:1;overflow-y:auto;display:flex;flex-direction:column;gap:8px;padding:10px;background:rgba(255,255,255,0.02);border-radius:8px}
.log-item{background:var(--card);padding:12px;border-radius:8px;border-left:4px solid var(--accent);font-size:0.9rem;color:#fff}
</style>
</head>
<body>

<div class="sidebar">
    <div class="side-btn" onclick="location.reload()">ğŸ </div>
    <div class="side-btn" onclick="checkStat('mic')">ğŸ¤</div>
    <div class="side-btn" onclick="checkStat('sys')">âš™ï¸</div>
</div>

<div class="main">
    <div style="display:flex;justify-content:space-between;margin-bottom:10px">
        <h2 style="margin:0">Mac Talk <span style="color:var(--accent)">PRO</span></h2>
        <div style="background:#222;padding:4px 10px;border-radius:15px;font-size:0.8rem">ğŸ‘ï¸ <span id="vCount">0</span></div>
    </div>
    <div class="card">
        <input id="tid" type="text" placeholder="TikTok ID (@ãªã—)">
        <button id="b1" class="btn-pink" onclick="clickStart()">1. èª­ã¿ä¸Šã’ã‚’æœ‰åŠ¹ã«ã™ã‚‹</button>
        <button id="b2" class="btn-blue" onclick="clickConnect()">2. ä¿å­˜ã—ã¦ãƒ©ã‚¤ãƒ–æ¥ç¶š</button>
    </div>
    <div id="log-area"><div class="log-item">ãƒ­ã‚°å¾…æ©Ÿä¸­...</div></div>
</div>

<audio id="silent-audio" loop playsinline src="https://raw.githubusercontent.com/anars/blank-audio/master/10-seconds-of-silence.mp3"></audio>

<script>
var socket = io();
var isEngineOn = false;
var queue = [];
var isTalking = false;
var connectTimer = null;
var seconds = 0;
var currentLog = null;

function addLog(msg, update = false) {
    var area = document.getElementById("log-area");
    if (update && currentLog) {
        currentLog.innerText = msg;
        return currentLog;
    }
    var d = document.createElement("div");
    d.className = "log-item";
    d.innerText = msg;
    area.insertBefore(d, area.firstChild);
    return d;
}

// ğŸ¤ã¨âš™ï¸ã®æ©Ÿèƒ½
function checkStat(mode) {
    if(mode === 'mic') addLog("ğŸ¤ èª­ã¿ä¸Šã’çŠ¶æ…‹: " + (isEngineOn ? "æœ‰åŠ¹" : "ç„¡åŠ¹"));
    else addLog("âš™ï¸ ã‚·ã‚¹ãƒ†ãƒ çŠ¶æ…‹: æ­£å¸¸ç¨¼åƒä¸­ / è¨ˆæ¸¬çµŒé: " + seconds.toFixed(1) + "s");
}

function clickStart() {
    isEngineOn = true;
    document.getElementById("silent-audio").play();
    var ut = new SpeechSynthesisUtterance("èª­ã¿ä¸Šã’ã‚’é–‹å§‹ã—ã¾ã™");
    ut.lang = 'ja-JP'; window.speechSynthesis.speak(ut);
    addLog("âœ… ã‚·ã‚¹ãƒ†ãƒ ï¼šéŸ³å£°ã‚¨ãƒ³ã‚¸ãƒ³èµ·å‹•");
    document.getElementById("b1").innerText = "èª­ã¿ä¸Šã’æœ‰åŠ¹ä¸­";
}

function clickConnect() {
    var id = document.getElementById("tid").value.replace("@", "").trim();
    if(!id) { alert("IDã‚’å…¥åŠ›ã—ã¦ãã ã•ã„"); return; }
    
    seconds = 0;
    if(connectTimer) clearInterval(connectTimer);
    currentLog = addLog("â³ æ¥ç¶šè¦æ±‚ä¸­... 0.0ç§’çµŒé");
    
    // 0.1ç§’ã”ã¨ã«ç§’æ•°ã‚’æ›´æ–°
    connectTimer = setInterval(function() {
        seconds += 0.1;
        addLog("â³ æ¥ç¶šè¦æ±‚ä¸­... " + seconds.toFixed(1) + "ç§’çµŒé", true);
    }, 100);
    
    socket.emit("setTarget", id);
    localStorage.setItem("mtid", id);
}

socket.on("ev", function(e) {
    if(e.t === "sys") {
        clearInterval(connectTimer); // æˆåŠŸ/å¤±æ•—ãŒæ¥ãŸã‚‰ã‚¿ã‚¤ãƒãƒ¼åœæ­¢
        addLog("ğŸ“¢ " + e.m + " (" + seconds.toFixed(1) + "ç§’)");
    }
    var s = "";
    if(e.t === "chat") { s = e.u + "ã•ã‚“ " + e.m; addLog("ğŸ’¬ " + e.u + ": " + e.m); }
    if(e.t === "follow") { s = e.u + "ã•ã‚“ãƒ•ã‚©ãƒ­ãƒ¼ã‚ã‚ŠãŒã¨ã†"; addLog("ğŸ‘¤ " + e.u + " Follow!"); }
    if(e.t === "gift") { s = e.u + "ã•ã‚“" + e.g + "ã‚ã‚ŠãŒã¨ã†"; addLog("ğŸ " + e.u + ": " + e.g + " x" + e.c); }
    if(s && isEngineOn) { queue.push(s); talk(); }
});

function talk() {
    if(!isEngineOn || isTalking || queue.length === 0) return;
    isTalking = true;
    var u = new SpeechSynthesisUtterance(queue.shift());
    u.lang = 'ja-JP'; u.rate = 1.2;
    u.onend = function() { isTalking = false; talk(); };
    window.speechSynthesis.speak(u);
}

window.onload = function() {
    var saved = localStorage.getItem("mtid");
    if(saved) document.getElementById("tid").value = saved;
};
</script>
</body>
</html>
