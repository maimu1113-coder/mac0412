<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<title>Mac Talk PRO STABLE</title>
<script src="/socket.io/socket.io.js"></script>
<style>
:root{--primary:#00f2ea;--secondary:#ff0050;--bg:#0d0d0d;--card:#1a1a1a}
body{font-family:-apple-system,sans-serif;background:var(--bg);color:#fff;margin:0;padding:env(safe-area-inset-top) 15px 20px;height:100vh;display:flex;flex-direction:column;overflow:hidden}
.mactalk-logo{text-align:center;font-size:2.8rem;font-weight:900;background:linear-gradient(90deg,#fff,var(--primary),#fff);background-size:200% auto;-webkit-background-clip:text;-webkit-text-fill-color:transparent;animation:shine 3s linear infinite;margin-top:40px}
@keyframes shine{to{background-position:200% center}}
.voice-btn{background:var(--secondary);border:none;padding:16px;border-radius:12px;color:#fff;font-weight:bold;margin-bottom:15px;box-shadow:0 4px 15px rgba(255,0,80,0.3)}
.voice-btn.active{background:#333;color:#888;box-shadow:none}
.input-group{display:flex;gap:8px;margin-bottom:15px}
input{flex:1;background:var(--card);border:1px solid #333;padding:15px;border-radius:12px;color:#fff;outline:none}
.connect-btn{background:var(--primary);border:none;padding:0 25px;border-radius:12px;font-weight:bold;color:#000}
.stats-panel{background:#161616;border-radius:18px;padding:15px;display:flex;gap:12px;border:1px solid #333;margin-bottom:10px}
#avatar{width:65px;height:65px;border-radius:50%;border:2px solid var(--primary);object-fit:cover;background:#222}
#chats{flex:1;overflow-y:auto;display:flex;flex-direction:column-reverse;gap:10px}
.chat-card{background:var(--card);padding:14px;border-radius:15px;border-left:5px solid var(--primary);animation:fadeIn 0.3s ease}
.gift-card{background:linear-gradient(45deg, #441111, #1a1a1a);border-left:5px solid var(--secondary)}
@keyframes fadeIn{from{opacity:0;transform:translateX(-10px)}to{opacity:1;transform:translateX(0)}}
</style>
</head>

<body>
<video id="pipVideo" playsinline muted loop style="position:fixed;width:1px;height:1px;opacity:0"><source src="https://raw.githubusercontent.com/Anarios/return-to-fame/master/assets/empty.mp4"></video>
<audio id="bgTracker" loop playsinline src="https://github.com/anars/blank-audio/raw/master/10-minutes-of-silence.mp3"></audio>

<div class="mactalk-logo">Mac Talk</div>
<button id="voiceInit" class="voice-btn">‚ö° SYSTEM START</button>

<div class="input-group">
    <input id="userId" placeholder="TikTok ID (@„Å™„Åó)">
    <button class="connect-btn" onclick="connect()">Êé•Á∂ö</button>
</div>

<div class="stats-panel">
    <img id="avatar" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7">
    <div>
        <div id="hostName" style="font-weight:bold;font-size:1.1rem">Êú™Êé•Á∂ö</div>
        <div style="font-size:0.75rem;color:#777">„Éï„Ç©„É≠„ÉØ„Éº <span id="followers">0</span> / Ë¶ñËÅ¥ËÄÖ <span id="currentView">0</span></div>
    </div>
</div>

<div id="chats"></div>

<script>
const socket=io();
let voiceEnabled=false, speechQueue=[], isSpeaking=false, audioCtx;
let currentSpeed = 1.2;

// --- „É≠„Éº„Ç´„É´Ë©±È°å„É™„Çπ„Éà ---
const AI_TOPICS=[
    "ÁöÜ„Åï„Çì„ÅÆ‰ªäÊó•„ÅÆ„É©„ÉÉ„Ç≠„Éº„Ç¢„Ç§„ÉÜ„É†„ÅØ‰Ωï„Åß„Åô„ÅãÔºü",
    "ÊúÄËøë„Éè„Éû„Å£„Å¶„ÅÑ„ÇãÂãïÁîª„Å®„Åã„ÅÇ„Çå„Å∞Êïô„Åà„Å¶„Åè„Å†„Åï„ÅÑÔºÅ",
    "ÂàùË¶ã„Åï„Çì„ÇÇÂ§ßÊ≠ìËøé„Åß„Åô„ÄÅ„ÇÜ„Å£„Åè„Çä„Åó„Å¶„ÅÑ„Å£„Å¶„Åè„Å†„Åï„ÅÑ„Å≠„ÄÇ",
    "„ÇÇ„Åó„Çà„Åë„Çå„Å∞„ÄÅ„Éï„Ç©„É≠„Éº„Å®„ÅÑ„ÅÑ„Å≠„ÅäÈ°ò„ÅÑ„Åó„Åæ„ÅôÔºÅ",
    "„Åì„ÅÆÊôÇÈñì„ÄÅÁöÜ„Åï„Çì‰Ωï„Åó„Å¶ÈÅé„Åî„Åó„Å¶„Åæ„Åô„ÅãÔºü",
    "‰ªäÊó•„ÅÆÊô©Âæ°È£Ø„ÄÅ‰ΩïÈ£ü„Åπ„Åü„ÅãÊïô„Åà„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ"
];

let lastChatTime=Date.now();
let lastAiTalkTime=0;
const SILENT_TRIGGER_MS=60000; // 1ÂàÜÁÑ°Ë®Ä„ÅßË©±È°åÊåØ„Çä
const AI_COOLDOWN_MS=180000;  // 3ÂàÜ„Å´1Âõû„Åæ„Åß

// --- iPhoneÁîüÂ≠òÁ∂≠ÊåÅ ---
async function keepAlive(){
    if(!audioCtx) audioCtx=new (window.AudioContext||window.webkitAudioContext)();
    if(audioCtx.state==='suspended') await audioCtx.resume();
    const o=audioCtx.createOscillator();
    const g=audioCtx.createGain();
    g.gain.value=0.0001; o.connect(g); g.connect(audioCtx.destination);
    o.start(); o.stop(audioCtx.currentTime+0.1);
}

// --- „Ç∑„Çπ„ÉÜ„É†Ëµ∑Âãï ---
voiceInit.onclick=async()=>{
    voiceEnabled=true;
    voiceInit.classList.add('active');
    voiceInit.textContent="‚ö° MONITORING...";
    await pipVideo.play();
    await bgTracker.play();
    setInterval(keepAlive, 1000);
    speak("ÂÆâÂÆöÂåñ„Ç∑„Çπ„ÉÜ„É†Ëµ∑Âãï„ÄÇÈü≥Â£∞„É¢„Éã„Çø„ÉºÈñãÂßã„Åó„Åæ„Åó„Åü„ÄÇ");
};

function connect(){
    if(!userId.value) return;
    chats.innerHTML="";
    socket.emit('setTargetUser', userId.value);
}

// --- „Ç§„Éô„É≥„ÉàÂèó‰ø° ---
socket.on('roomInfo',d=>{
    avatar.src=d.avatar||avatar.src;
    hostName.textContent=d.nickname;
    followers.textContent=d.followerCount.toLocaleString();
    currentView.textContent=d.viewerCount.toLocaleString();
    speak(d.nickname + "„Å´Êé•Á∂öÊàêÂäü„ÄÇ");
});

socket.on('viewerUpdate',d=>{ currentView.textContent=d.viewerCount.toLocaleString(); });

socket.on('chat',d=>{
    lastChatTime=Date.now();
    
    // ÁÆ°ÁêÜËÄÖ„Ç≥„Éû„É≥„ÉâÂà§ÂÆö (!stop, !start, !speed 1.5)
    if(d.comment.startsWith('!')){
        if(d.comment==='!stop') { voiceEnabled=false; speak("ÂÅúÊ≠¢„Åó„Åæ„Åô"); return; }
        if(d.comment==='!start') { voiceEnabled=true; speak("ÂÜçÈñã„Åó„Åæ„Åô"); return; }
        if(d.comment.startsWith('!speed')){
            let s = parseFloat(d.comment.split(' ')[1]);
            if(s >= 0.5 && s <= 2.0) { currentSpeed = s; speak("ÈÄüÂ∫¶„Çí"+s+"„Å´Â§âÊõ¥"); }
            return;
        }
    }

    const c=document.createElement('div');
    c.className='chat-card';
    c.innerHTML=`<b style="color:var(--primary)">@${d.nickname}</b><br>${d.comment}`;
    chats.prepend(c);

    if(voiceEnabled){
        const cleanName = d.nickname.replace(/[^\w‰∏Ä-Èæ†„ÅÅ-„Çì„Ç°-„É≥]/g,'');
        speak(cleanName + "„Åï„Çì„ÄÅ" + d.comment);
    }
});

socket.on('gift',d=>{
    const c=document.createElement('div');
    c.className='chat-card gift-card';
    c.innerHTML=`<b style="color:var(--secondary)">üéÅ ${d.nickname}</b><br>${d.giftName} x ${d.repeatCount}`;
    chats.prepend(c);
    speak(d.nickname + "„Åï„Çì„ÄÅ" + d.giftName + "„ÅÇ„Çä„Åå„Å®„ÅÜÔºÅ");
});

// --- ÁÑ°Ë®ÄÊôÇ„ÅÆË©±È°åÊåØ„Çä ---
setInterval(()=>{
    if(!voiceEnabled || isSpeaking) return;
    const now = Date.now();
    if(now - lastChatTime < SILENT_TRIGGER_MS) return;
    if(now - lastAiTalkTime < AI_COOLDOWN_MS) return;

    lastAiTalkTime = now;
    const topic = AI_TOPICS[Math.floor(Math.random()*AI_TOPICS.length)];
    speak(topic);
}, 5000);

// --- Ë™≠„Åø‰∏ä„Åí„Ç≥„Ç¢ ---
function speak(t){
    if(!voiceEnabled) return;
    const u=new SpeechSynthesisUtterance(t);
    u.lang='ja-JP'; u.rate=currentSpeed;
    u.onend=()=>{ isSpeaking=false; process(); };
    speechQueue.push(u);
    if(!isSpeaking) process();
}
function process(){
    if(!speechQueue.length) return;
    isSpeaking=true;
    window.speechSynthesis.speak(speechQueue.shift());
}
</script>
</body>
</html>
