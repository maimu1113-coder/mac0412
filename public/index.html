<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>TikTok Monitor PRO+</title>
    <script src="/socket.io/socket.io.js"></script>
    <style>
        :root { --primary: #00f2ea; --secondary: #ff0050; --bg: #0d0d0d; --card: #1a1a1a; }
        body { font-family: sans-serif; background: var(--bg); color: white; margin: 0; padding: env(safe-area-inset-top) 15px 20px; height: 100vh; display: flex; flex-direction: column; box-sizing: border-box; }
        
        /* ãƒœã‚¿ãƒ³ä½ç½®ã‚’ã‹ãªã‚Šä¸‹ã’ã¦ã€è¦ªæŒ‡ã§æŠ¼ã—ã‚„ã™ãã€ç”»é¢ä¸Šéƒ¨ã‹ã‚‰ã‚‚é›¢ã—ã¾ã—ãŸ */
        .header { padding-top: 50px; margin-bottom: 20px; }
        .voice-btn { background: linear-gradient(45deg, var(--secondary), #ff4d88); color: white; border: none; padding: 18px; border-radius: 15px; font-weight: bold; width: 100%; margin-bottom: 15px; font-size: 1.1rem; box-shadow: 0 4px 15px rgba(255, 0, 80, 0.4); }
        .input-group { display: flex; gap: 10px; margin-bottom: 20px; }
        input { flex: 1; background: var(--card); border: 2px solid #333; padding: 15px; border-radius: 12px; color: white; font-size: 1rem; outline: none; }
        input:focus { border-color: var(--primary); }
        .connect-btn { background: var(--primary); border: none; padding: 0 25px; border-radius: 12px; font-weight: bold; color: #000; cursor: pointer; }

        .stats-panel { background: #161616; border-radius: 18px; padding: 18px; display: flex; align-items: center; gap: 15px; border: 1px solid #333; margin-bottom: 20px; }
        #avatar { width: 60px; height: 60px; border-radius: 50%; background: #333; border: 2px solid var(--primary); }
        .stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; flex: 1; }
        .stat-val { color: var(--primary); font-weight: bold; font-size: 1.1rem; display: block; }

        #chats { flex: 1; overflow-y: auto; display: flex; flex-direction: column-reverse; gap: 12px; }
        .chat-card { background: var(--card); padding: 15px; border-radius: 15px; border-left: 5px solid var(--primary); box-shadow: 0 2px 10px rgba(0,0,0,0.3); }
    </style>
</head>
<body>
    <div class="header">
        <button id="voiceInit" class="voice-btn">ã€ ğŸ”Š èª­ã¿ä¸Šã’ã‚’æœ‰åŠ¹ã«ã™ã‚‹ ã€‘</button>
        <div class="input-group">
            <input id="userId" placeholder="TikTok IDã‚’å…¥åŠ›">
            <button class="connect-btn" onclick="connect()">æ¥ç¶š</button>
        </div>
    </div>

    <div id="statsPanel" class="stats-panel">
        <img id="avatar" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7">
        <div style="flex:1">
            <div id="hostName" style="font-size:1.1rem; font-weight:bold; margin-bottom:6px;">æœªæ¥ç¶š</div>
            <div class="stats-grid">
                <div>ãƒ•ã‚©ãƒ­ãƒ¯ãƒ¼<span id="followers" class="stat-val">0</span></div>
                <div>ç¾åœ¨<span id="currentView" class="stat-val">0</span></div>
            </div>
        </div>
    </div>

    <div id="chats"></div>

    <script>
        const socket = io();
        let voiceEnabled = false;
        let speechQueue = [];
        let isSpeaking = false;

        // ã€æœ€å¼·ã®é™¤èŒãƒ«ãƒ¼ãƒ«ã€‘æ—¥æœ¬èªãƒ»è‹±èªãƒ»æ•°å­—ä»¥å¤–ã¯ã€Œåå‰ã€ã‹ã‚‰ã‚‚ã€Œã‚³ãƒ¡ãƒ³ãƒˆã€ã‹ã‚‰ã‚‚æ¶ˆã—ã¾ã™
        const superClean = (text) => {
            if(!text) return "";
            return text
                .replace(/[^\u3041-\u3096\u30A1-\u30F6\u4E00-\u9FFF\uFF66-\uFF9F\u0030-\u0039\u0041-\u005A\u0061-\u007A\u3005\u3007\u303B]/g, '')
                .trim();
        };

        document.getElementById('voiceInit').addEventListener('click', function() {
            voiceEnabled = true;
            window.speechSynthesis.cancel();
            speak("èª­ã¿ä¸Šã’æ©Ÿèƒ½ã‚’æœ‰åŠ¹ã«ã—ã¾ã—ãŸã€‚ã‚¢ã‚¤ãƒ‡ã‚£ãƒ¼ã‚’å…¥åŠ›ã—ã¦æ¥ç¶šã—ã¦ãã ã•ã„ã€‚");
            this.innerText = "ğŸ”Š ç¨¼åƒä¸­";
            this.style.background = "#333";
            this.style.boxShadow = "none";
        });

        function connect() {
            const id = document.getElementById('userId').value;
            if(!id) return;
            speechQueue = [];
            window.speechSynthesis.cancel();
            speak(`${id} ã¸ã®æ¥ç¶šã‚’é–‹å§‹ã—ã¾ã™ã€‚`); // æ¥ç¶šé–‹å§‹ã‚’å£°ã§ãŠçŸ¥ã‚‰ã›
            socket.emit('setTargetUser', id);
        }

        socket.on('roomInfo', (data) => {
            document.getElementById('avatar').src = data.avatar;
            document.getElementById('hostName').innerText = data.nickname;
            document.getElementById('followers').innerText = data.followerCount.toLocaleString();
            
            const cleanHost = superClean(data.nickname) || "ãƒ©ã‚¤ãƒ–";
            speak(`${cleanHost} ã«æ¥ç¶šã—ã¾ã—ãŸã€‚åŒå¸­æ•°ã¯ç¾åœ¨ ${data.viewerCount} äººã§ã™ã€‚`); // æ¥ç¶šæˆåŠŸã‚’å£°ã§ãŠçŸ¥ã‚‰ã›
        });

        socket.on('viewerUpdate', (data) => {
            document.getElementById('currentView').innerText = data.viewerCount.toLocaleString();
        });

        socket.on('chat', (data) => {
            const card = document.createElement('div');
            card.className = 'chat-card';
            card.innerHTML = `<span style="color:var(--primary); font-size:0.85rem; font-weight:bold;">@${data.nickname}</span><br>${data.comment}`;
            document.getElementById('chats').prepend(card);
            
            if(voiceEnabled) {
                let name = superClean(data.nickname);
                let msg = superClean(data.comment);
                if(msg) speak(`${name}ã•ã‚“ã€${msg}`);
            }
        });

        socket.on('gift', (data) => {
            const card = document.createElement('div');
            card.className = 'chat-card';
            card.style.borderLeftColor = 'var(--secondary)';
            card.innerHTML = `<span style="color:var(--secondary); font-weight:bold;">ğŸ @${data.nickname}</span><br>${data.giftName}ï¼`;
            document.getElementById('chats').prepend(card);
            
            let name = superClean(data.nickname);
            speak(`${name}ã•ã‚“ã€ã‚®ãƒ•ãƒˆã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ï¼`);
        });

        function speak(t) {
            if(!voiceEnabled) return;
            speechQueue.push(t);
            if(!isSpeaking) process();
        }

        function process() {
            if(speechQueue.length === 0) { isSpeaking = false; return; }
            isSpeaking = true;
            const u = new SpeechSynthesisUtterance(speechQueue.shift());
            u.lang = 'ja-JP'; u.rate = 1.05;
            u.onend = () => { setTimeout(process, 100); };
            u.onerror = () => { isSpeaking = false; process(); };
            window.speechSynthesis.speak(u);
        }
    </script>
</body>
</html>
