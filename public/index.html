<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>Mac Talk PRO - AI Hybrid</title>
    <script src="/socket.io/socket.io.js"></script>
    <style>
        :root { --primary: #00f2ea; --secondary: #ff0050; --bg: #0d0d0d; --card: #1a1a1a; }
        body { font-family: -apple-system, sans-serif; background: var(--bg); color: white; margin: 0; padding: env(safe-area-inset-top) 15px 20px; height: 100vh; display: flex; flex-direction: column; box-sizing: border-box; overflow: hidden; }
        .mactalk-logo { font-size: 2.8rem; font-weight: 900; text-align: center; background: linear-gradient(90deg, #fff, var(--primary), #fff); -webkit-background-clip: text; -webkit-text-fill-color: transparent; animation: shine 3s linear infinite; margin-top: 40px; }
        @keyframes shine { to { background-position: 200% center; } }
        .voice-btn { background: var(--secondary); color: white; border: none; padding: 16px; border-radius: 12px; font-weight: bold; width: 100%; margin-bottom: 15px; font-size: 1.1rem; }
        .voice-btn.active { background: #333; color: #888; }
        .input-group { display: flex; gap: 8px; margin-bottom: 15px; }
        input { flex: 1; background: var(--card); border: 1px solid #333; padding: 15px; border-radius: 12px; color: white; outline: none; }
        .connect-btn { background: var(--primary); border: none; padding: 0 25px; border-radius: 12px; font-weight: bold; color: #000; }
        .stats-panel { background: #161616; border-radius: 18px; padding: 15px; display: flex; align-items: center; gap: 12px; border: 1px solid #333; margin-bottom: 15px; }
        #avatar { width: 60px; height: 60px; border-radius: 50%; border: 2px solid var(--primary); object-fit: cover; }
        #chats { flex: 1; overflow-y: auto; display: flex; flex-direction: column-reverse; gap: 10px; padding-bottom: 20px; }
        .chat-card { background: var(--card); padding: 12px; border-radius: 15px; border-left: 5px solid var(--primary); }
    </style>
</head>
<body>
    <video id="pipVideo" playsinline muted loop style="position:fixed; width:1px; height:1px; opacity:0; pointer-events:none;">
        <source src="https://raw.githubusercontent.com/Anarios/return-to-fame/master/assets/empty.mp4" type="video/mp4">
    </video>
    <audio id="bgTracker" loop playsinline src="https://github.com/anars/blank-audio/raw/master/10-minutes-of-silence.mp3"></audio>

    <div class="mactalk-logo">Mac Talk</div>
    <button id="voiceInit" class="voice-btn">⚡ AI HYBRID ACTIVE</button>
    <div class="input-group">
        <input id="userId" placeholder="TikTok ID">
        <button class="connect-btn" onclick="connect()">接続</button>
    </div>
    <div class="stats-panel">
        <img id="avatar" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7">
        <div style="flex:1">
            <div id="hostName" style="font-weight:bold;">未接続</div>
            <div style="font-size: 0.75rem; color: #777;">
                フォロー: <span id="followers" style="color:var(--primary)">0</span> | 現在: <span id="currentView" style="color:var(--primary)">0</span>
            </div>
        </div>
    </div>
    <div id="chats"></div>

    <script>
        const socket = io();
        let voiceEnabled = false, speechQueue = [], isSpeaking = false, audioCtx;
        
        // --- AI話題振り用設定 ---
        let lastChatTime = Date.now();
        let lastAiTalkTime = 0;
        let aiTalking = false;
        const SILENT_TRIGGER_MS = 60000; // 60秒無言で発動
        const AI_COOLDOWN_MS = 180000;   // 1回喋ったら3分待機
        const OPENAI_API_KEY = "YOUR_API_KEY"; // ここにキーを入力

        // 自動再接続
        socket.on('connect', () => {
            const id = document.getElementById('userId').value;
            if (id) socket.emit('setTargetUser', id);
        });

        async function keepAlive() {
            if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            if (audioCtx.state === 'suspended') await audioCtx.resume();
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            gain.gain.value = 0.0001;
            osc.connect(gain); gain.connect(audioCtx.destination);
            osc.start(); osc.stop(audioCtx.currentTime + 0.1);
        }

        document.getElementById('voiceInit').addEventListener('click', async function() {
            voiceEnabled = true;
            this.classList.add('active'); this.innerText = "⚡ AI MODE: ON";
            try {
                await document.getElementById('pipVideo').play();
                await document.getElementById('bgTracker').play();
                setInterval(keepAlive, 1000);
            } catch (e) { console.error(e); }
            speak("AIハイブリッドモード、起動しました。");
        });

        function connect() {
            const id = document.getElementById('userId').value;
            if(!id) return;
            socket.emit('setTargetUser', id);
        }

        socket.on('roomInfo', data => {
            if(data.avatar) document.getElementById('avatar').src = data.avatar;
            document.getElementById('hostName').innerText = data.nickname;
            speak(data.nickname + "に接続。");
        });

        // コメント受信
        socket.on('chat', (data) => {
            lastChatTime = Date.now(); // 無言タイマーリセット
            aiTalking = false;         // AIモード解除

            const card = document.createElement('div');
            card.className = 'chat-card';
            card.innerHTML = `<span style="color:var(--primary); font-size:0.8rem; font-weight:bold;">@${data.nickname}</span><br>${data.comment}`;
            document.getElementById('chats').prepend(card);
            
            if(voiceEnabled) {
                const n = data.nickname.replace(/[^\u3041-\u3096\u30A1-\u30F6\u4E00-\u9FFF0-9A-Za-z]/g, '');
                const m = data.comment.replace(/[^\u3041-\u3096\u30A1-\u30F6\u4E00-\u9FFF0-9A-Za-z]/g, '');
                if(m) speak(n + "さん、" + m);
            }
        });

        // AI話題振り監視ループ (5秒おきにチェック)
        setInterval(async () => {
            if (!voiceEnabled || isSpeaking || aiTalking) return;

            const now = Date.now();
            if (now - lastChatTime < SILENT_TRIGGER_MS) return;
            if (now - lastAiTalkTime < AI_COOLDOWN_MS) return;

            aiTalking = true;
            lastAiTalkTime = now;

            try {
                const topic = await getAiTopic();
                if (topic) speak("（AIアシスタント）" + topic);
            } catch (e) {
                console.error('AI Error:', e);
                aiTalking = false;
            }
        }, 5000);

        async function getAiTopic() {
            if (OPENAI_API_KEY === "YOUR_API_KEY") return "APIキーが設定されていません。";
            
            const res = await fetch('https://api.openai.com/v1/chat/completions', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${OPENAI_API_KEY}`
                },
                body: JSON.stringify({
                    model: 'gpt-4o-mini',
                    messages: [
                        { role: 'system', content: 'TikTok配信のアシスタントです。無言が続いているので、視聴者がコメントしたくなるような軽い質問や話題を1つ、15秒以内で話してください。' },
                        { role: 'user', content: '何か面白い話題を振って。' }
                    ],
                    max_tokens: 80,
                    temperature: 0.8
                })
            });
            const data = await res.json();
            return data.choices?.[0]?.message?.content || null;
        }

        function speak(t) {
            if(!voiceEnabled) return;
            const u = new SpeechSynthesisUtterance(t);
            u.lang = 'ja-JP'; u.rate = 1.2;
            u.onend = () => { isSpeaking = false; process(); };
            speechQueue.push(u);
            if(!isSpeaking) process();
        }

        function process() {
            if(speechQueue.length === 0) return;
            isSpeaking = true;
            window.speechSynthesis.speak(speechQueue.shift());
        }
    </script>
</body>
</html>
