<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TikTok Live Monitor ULTIMATE</title>
    <script src="/socket.io/socket.io.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        :root { --primary: #00f2ea; --secondary: #ff0050; --bg: #0d0d0d; --surface: #1a1a1a; }
        body { font-family: 'Segoe UI', sans-serif; background-color: var(--bg); color: white; margin: 0; padding: 20px; display: flex; flex-direction: column; height: 100vh; box-sizing: border-box; }
        .header { display: flex; align-items: center; justify-content: space-between; padding-bottom: 20px; border-bottom: 2px solid var(--surface); }
        .header h1 { font-size: 1.5rem; margin: 0; background: linear-gradient(to right, var(--primary), var(--secondary)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .voice-btn { background: var(--secondary); color: white; border: none; padding: 10px 20px; border-radius: 50px; font-weight: bold; cursor: pointer; box-shadow: 0 0 15px rgba(255, 0, 80, 0.4); animation: pulse 2s infinite; }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }
        .controls { display: flex; gap: 10px; margin: 20px 0; }
        input { flex-grow: 1; background: var(--surface); border: 1px solid #333; padding: 12px; border-radius: 8px; color: white; }
        button.connect-btn { background: var(--primary); color: black; border: none; padding: 12px 25px; border-radius: 8px; font-weight: bold; cursor: pointer; }
        #chats { flex-grow: 1; overflow-y: auto; display: flex; flex-direction: column-reverse; gap: 10px; }
        .chat-card { background: var(--surface); padding: 12px; border-radius: 10px; border-left: 4px solid var(--primary); animation: slideIn 0.3s; }
        .gift-card { background: rgba(255, 0, 80, 0.1); border-left: 4px solid var(--secondary); border: 1px solid var(--secondary); }
        @keyframes slideIn { from { opacity: 0; transform: translateX(-20px); } to { opacity: 1; transform: translateX(0); } }
        .nickname { color: var(--primary); font-weight: bold; font-size: 0.85rem; display: block; }
    </style>
</head>
<body>
    <div class="header">
        <h1><i class="fab fa-tiktok"></i> LIVE MONITOR ULTIMATE</h1>
        <button id="voiceInit" class="voice-btn">Èü≥Â£∞„ÇíÊúâÂäπÂåñ</button>
    </div>

    <div class="controls">
        <input id="userId" placeholder="TikTok„É¶„Éº„Ç∂„ÉºID„ÇíÂÖ•Âäõ...">
        <button class="connect-btn" onclick="connect()">Êé•Á∂ö</button>
    </div>
    
    <div id="status">ÂæÖÊ©ü‰∏≠</div>
    <div id="chats"></div>

    <script>
        const socket = io();
        let isVoiceEnabled = false;
        let speechQueue = []; // Ë™≠„Åø‰∏ä„ÅíÂæÖ„Å°„ÅÆ„É™„Çπ„Éà
        let isSpeaking = false;

        // „ÇÆ„Éï„ÉàÈÄöÁü•Áî®„ÅÆÈü≥ÔºàÈõªÂ≠êÈü≥„ÇíÁîüÊàêÔºâ
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        function playGiftSound() {
            const oscillator = audioCtx.createOscillator();
            const gainNode = audioCtx.createGain();
            oscillator.connect(gainNode);
            gainNode.connect(audioCtx.destination);
            oscillator.type = 'sine';
            oscillator.frequency.setValueAtTime(880, audioCtx.currentTime); // „É©„ÅÆÈü≥
            oscillator.frequency.exponentialRampToValueAtTime(440, audioCtx.currentTime + 0.2);
            gainNode.gain.setValueAtTime(0.1, audioCtx.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.2);
            oscillator.start();
            oscillator.stop(audioCtx.currentTime + 0.2);
        }

        document.getElementById('voiceInit').addEventListener('click', function() {
            isVoiceEnabled = true;
            audioCtx.resume();
            this.innerHTML = 'Èü≥Â£∞ÊúâÂäπ‰∏≠';
            this.style.background = "#333";
            this.style.animation = "none";
        });

        function connect() {
            const id = document.getElementById('userId').value;
            if(!id) return;
            socket.emit('setTargetUser', id);
        }

        // È†ÜÁï™„Å´Ë™≠„Åø‰∏ä„Åí„Çã„Åü„ÇÅ„ÅÆÈñ¢Êï∞
        function processQueue() {
            if (isSpeaking || speechQueue.length === 0) return;
            isSpeaking = true;
            const text = speechQueue.shift();
            const uttr = new SpeechSynthesisUtterance(text);
            uttr.lang = 'ja-JP';
            uttr.rate = 1.2;
            uttr.onend = () => {
                isSpeaking = false;
                processQueue(); // Ê¨°„ÅÆ„Ç≥„É°„É≥„Éà„Å∏
            };
            window.speechSynthesis.speak(uttr);
        }

        socket.on('chat', (data) => {
            const chatBox = document.getElementById('chats');
            const card = document.createElement('div');
            card.className = 'chat-card';
            card.innerHTML = `<span class="nickname">@${data.nickname}</span>${data.comment}`;
            chatBox.prepend(card);

            if (isVoiceEnabled) {
                let cleanComment = data.comment.replace(/([\u2700-\u27BF]|[\uE000-\uF8FF]|\uD83C[\uDC00-\uDFFF]|\uD83D[\uDC00-\uDFFF]|[\u2011-\u26FF]|\uD83E[\uDD10-\uDDFF])/g, '');
                if (cleanComment.trim().length > 0) {
                    speechQueue.push(`${data.nickname}„Åï„Çì„ÄÇ ${cleanComment}`);
                    processQueue();
                }
            }
        });

        // „ÇÆ„Éï„Éà„ÇíÂèó„ÅëÂèñ„Å£„ÅüÊôÇ„ÅÆÂá¶ÁêÜ
        socket.on('gift', (data) => {
            if (isVoiceEnabled) {
                playGiftSound(); // „ÇÆ„Éï„ÉàÈü≥„ÇíÈ≥¥„Çâ„Åô
            }
            const chatBox = document.getElementById('chats');
            const card = document.createElement('div');
            card.className = 'chat-card gift-card';
            card.innerHTML = `<span class="nickname">üéÅ @${data.nickname}</span>${data.giftName}„ÇíË¥à„Çä„Åæ„Åó„ÅüÔºÅ`;
            chatBox.prepend(card);
        });
    </script>
</body>
</html>
