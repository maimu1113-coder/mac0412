<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>MacTok PRO</title>
<script src="/socket.io/socket.io.js"></script>
<style>
  body { margin: 0; background: #000; color: #fff; font-family: sans-serif; display: flex; align-items: center; justify-content: center; min-height: 100vh; }
  .card { background: #111; border-radius: 25px; padding: 25px; width: 90%; max-width: 380px; text-align: center; border: 1px solid #222; box-shadow: 0 0 40px rgba(255,0,80,0.2); }
  .pro { color: #ff0050; font-weight: bold; }
  input { width: 100%; padding: 18px; margin-bottom: 20px; border-radius: 15px; border: 1px solid #333; background: #000; color: #fff; text-align: center; font-size: 18px; box-sizing: border-box; }
  button { width: 100%; padding: 18px; border-radius: 40px; border: none; background: #ff0050; color: #fff; font-size: 20px; font-weight: bold; cursor: pointer; transition: 0.2s; }
  button:active { transform: scale(0.95); }
  #comment-box { height: 250px; overflow-y: auto; background: #050505; border-radius: 15px; padding: 15px; text-align: left; font-size: 15px; margin-top: 20px; border: 1px solid #222; }
  .comment { margin-bottom: 12px; border-bottom: 1px solid #111; padding-bottom: 8px; line-height: 1.4; }
  .user { color: #ff0050; font-weight: bold; font-size: 11px; }
  #status-label { font-size: 13px; color: #666; margin-top: 15px; display: block; }
</style>
</head>
<body>
<div class="card">
  <div style="font-size: 24px; font-weight: bold; margin-bottom: 25px;">MacTok <span class="pro">PRO</span></div>
  <input type="text" id="id-input" placeholder="IDを入力 (例: Katoutokuiten1)">
  <button onclick="start()">エンジン始動</button>
  <div id="comment-box">コメント待機中...</div>
  <span id="status-label">Ready</span>
</div>

<script>
const socket = io({ transports: ["polling"] });
const synth = window.speechSynthesis;
let isVoiceOk = false;

function speak(text) {
    if (!isVoiceOk) return;
    synth.cancel();
    const ut = new SpeechSynthesisUtterance(text);
    ut.lang = 'ja-JP';
    ut.rate = 1.3;
    synth.speak(ut);
}

async function start() {
    const id = document.getElementById("id-input").value.trim();
    if (!id) return;
    isVoiceOk = true;
    speak(" "); // 音声エンジンのアクティベート
    document.getElementById("status-label").innerText = "⏳ 接続しています...";
    socket.emit("connect-live", id);
}

socket.on("new-comment", (data) => {
    const box = document.getElementById("comment-box");
    if(box.innerText.includes("待機中")) box.innerHTML = "";
    const el = document.createElement("div");
    el.className = "comment";
    el.innerHTML = `<span class="user">@${data.user}</span><br>${data.text}`;
    box.prepend(el);
    speak(data.text);
});

socket.on("live-status", (msg) => {
    document.getElementById("status-label").innerText = msg;
});
</script>
</body>
</html>
